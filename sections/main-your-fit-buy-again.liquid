<style>
  .timeline-steps::before {
    content: '';
    position: absolute;
    left: 0px;
    top: 3rem;
    bottom: 4rem;
    width: 2px;
    background-color: #9c876d;
    height: 0;
    z-index: 1;
    animation: drawLine 2s cubic-bezier(0.4, 0, 0.2, 1) 0.5s forwards;
  }

  .step-item span {
    z-index: 10;
  }

  .step-1 .step-item__content {
    opacity: 1;
  }

  .step-2 .step-item__content {
    animation: fadeInStep 0.6s ease 0.6s forwards;
  }

  .step-3 .step-item__content {
    animation: fadeInStep 0.6s ease 1.6s forwards;
  }

  /* Line drawing animation */
  @keyframes drawLine {
    0% {
      height: 0;
    }
    30% {
      height: 4rem;
    }
    60% {
      height: 8rem;
    }
    100% {
      height: calc(100% - 7rem);
    }
  }

  @keyframes fadeInStep {
    from {
      opacity: 0.3;
    }
    to {
      opacity: 1;
    }
  }
</style>

<div class="page-width py-8">
  <quiz-results data-fallback-url="{{ section.settings.fallback_redirect_url | default: '/pages/quiz' }}">
    <div class="quiz-results__success">
      <div class="quiz-results__success-content text-center">
        <!-- Doctor Image -->
        <div class="before:bg-blue-fitness/50 relative mb-8 before:absolute before:top-1/2 before:left-1/2 before:-z-1 before:h-px before:w-full before:-translate-1/2 before:-translate-x-1/2">
          <div class="bg-blue-fitness mx-auto h-28 w-28 overflow-hidden rounded-full">
            {{ section.settings.avatar | image_url: width: 224 | image_tag: class: 'h-full w-full object-cover' }}
          </div>
        </div>

        {%- if section.settings.title != blank -%}
          <h1 class="mb-4 text-3xl font-bold text-gray-900 md:text-4xl">{{ section.settings.title }}</h1>
        {%- endif -%}

        {%- if section.settings.subtitle != blank -%}
          <p class="text-lg text-gray-600">This is what happens next:</p>
        {%- endif -%}

        <!-- CTA Button -->
        <div class="mt-4 mb-8">
          <button
            id="quiz-results-add-to-cart-btn"
            type="button"
            class="btn-primary text-xl font-semibold"
          >
            <div class="btn-primary__inner">
              <div class="btn-primary__text-wrapper">
                <div class="btn-primary__text">Let’s Go →</div>
                <div class="btn-primary__text">Let’s Go →</div>
              </div>
            </div>
          </button>
        </div>

        <div class="quiz-results__steps mx-auto max-w-md text-left">
          <ol class="timeline-steps relative mb-12 ml-8 text-gray-500">
            {%- for block in section.blocks -%}
              <li class="step-item step-{{ forloop.index }} ms-16 mb-16">
                <span class="absolute -start-8 flex h-16 w-16 items-center justify-center rounded-lg bg-orange-100 ring-8 ring-white">
                  {{ block.settings.icon | image_url: width: 16 | image_tag: class: 'h-full w-full object-cover' }}
                </span>
                <div class="step-item__content {% unless forloop.first %}opacity-30{% endunless %}">
                  <h3 class="mb-2 text-xl font-semibold text-gray-900">{{ block.settings.title }}</h3>
                  <p class="text-gray-500">{{ block.settings.subtitle }}</p>
                </div>
              </li>
            {%- endfor -%}
          </ol>
        </div>
      </div>
    </div>

    <!-- Blank fallback content (hidden by default) -->
    <div class="quiz-results__no-data" style="display: none;">
      <!-- Completely blank - just takes up space to prevent flash -->
      <div class="min-h-screen"></div>
    </div>
  </quiz-results>
</div>

{% javascript %}
  /*
  TESTING URLS:

  Example URL: one shoe type selected
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Running%20Shoes&Additional%20Info=nothing%20to%20say%20really

  Example URL: one shoe type selected, enter condition logic. condition shoe type is null
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Sesamoiditis&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Running%20Shoes&Additional%20Info=nothing%20to%20say%20really
  
  Example URL: multiple shoe types selected: Boots, Dress Shoes, Running Shoes
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Boots%2C%20Dress%20Shoes%2C%20Running%20Shoes&Additional%20Info=nothing%20to%20say%20really

  Example URL: multiple shoe types selected: Boots, Dress Shoes, Running Shoes, Pickeball Shoes
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Boots%2C%20Dress%20Shoes%2C%20Running%20Shoes&Pickleball%20Shoes&Additional%20Info=nothing%20to%20say%20really


  all shoe types selected for testing
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=All%20the%20time&Condition=Flat%20Feet&Pain%20Region%20(R)=Inside%20Ankle%2C%20Outer%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)%2C%20Outer%20Ankle%2C%20Big%20Toe&Size=Mens%2010.5&Shoe%20Type=Sneakers%20(Also%20known%20as%20%27Tennis%20Shoes%27)%2C%20Running%20Shoes%2C%20Pickleball%20Shoes%2C%20Boots%2C%20Dress%20Shoes%2C%20Golf%20Shoes%2C%20Cycling%20Shoes%2C%20Soccer%20Cleats%2C%20Heels%2C%20Ski%20Boots%2C%20Ice%20Skates%2C%20Ice%20Skates%20(Hockey)%2C%20Basketball%20Shoes&Additional%20Info=nothing%20of%20note


  null shoe type selected: Heels
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Heels&Additional%20Info=nothing%20to%20say%20really

  2 null shoe type selected: Heels, Golf Shoes
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Heels%2C%20Golf%20Shoes&Additional%20Info=nothing%20to%20say%20really

  2 null shoe types, 1 valid shoe type selected: Heels, Golf Shoes, Running Shoes 
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Heels%2C%20Golf%20Shoes%2C%20Running%20Shoes&Additional%20Info=nothing%20to%20say%20really

  null shoe type and valid shoe type selected: heels, running shoes
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40642850455616?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle%2C%20Back%20of%20Ankle%20(Achilles%20Tendon)&Pain%20Region%20(L)=Outer%20Ankle%2C%20Inside%20Ankle&Size=Mens%2010.5&Shoe%20Type=Heels%2C%20Running%20Shoes&Additional%20Info=nothing%20to%20say%20really


  customer reported bug. skipped most form questions
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40606957371456?checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=_____&Pain%20Frequency=_____&Condition=Flat%20Feet&Pain%20Region%20(R)=_____&Pain%20Region%20(L)=_____&Size=Mens%2011&Shoe%20Type=Sneakers%20(Also%20known%20as%20%27Tennis%20Shoes%27)&Additional%20Info=asdf
  
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40606957371456&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=_____&Arch=_____&Pain%20Frequency=_____&Condition=None&Pain%20Region%20(R)=_____&Pain%20Region%20(L)=_____&Size=Mens%201&Shoe%20Type=Boots&Additional%20Info=asdf
  

  quiz 2: skips all skippable questions
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40660476035136&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=_____&Arch=&Pain%20Frequency=_____&Condition=Hammer%20Toes&Pain%20Region%20(R)=_____&Pain%20Region%20(L)=_____&Size=_____%20_____&Shoe%20Type=Boots&Additional%20Info=1


  quiz 2: mostly all questions answered
  https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40618221404224&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=&Pain%20Frequency=After%20a%20long%20day&Condition=None&Pain%20Region%20(R)=Heel%2C%20Big%20Toe&Pain%20Region%20(L)=Toes%20(Metatarsal%20heads%20II-V)&Size=Mens%204.5&Shoe%20Type=Sneakers%20(Also%20known%20as%20%27Tennis%20Shoes%27)&Additional%20Info=notes!
  

  // https://www.stridesoles.com/pages/buy-again-your-fit?quiz_complete=true&variant=40700984754240&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=General%20Wellness&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Bunions&Pain%20Region%20(R)=Outer%20Ankle&Pain%20Region%20(L)=Back%20of%20Ankle%20(Achilles%20Tendon)&Size=Mens%20123&Shoe%20Type=Dress%20Shoes&Additional%20Info=123

  // https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40606957371456&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=General%20Wellness&Arch=Normal%20Arch&Pain%20Frequency=Once%20in%20a%20while&Condition=Hammer%20Toes%2C%20Limb-Length%20Discrepancy&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle&Pain%20Region%20(L)=_____&Size=Mens%2012&Shoe%20Type=Pickleball%20Shoes&Additional%20Info=1

  // https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40606957404224&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Foot%20Pain&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Plantar%20Fasciitis&Pain%20Region%20(R)=Outer%20Ankle%2C%20Inside%20Ankle&Pain%20Region%20(L)=Outer%20Ankle&Size=Mens%2012&Shoe%20Type=Dress%20Shoes&Additional%20Info=1

  // https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40606957436992&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=General%20Wellness&Arch=Flat%20Foot&Pain%20Frequency=All%20the%20time&Condition=Bunions%2C%20Hammer%20Toes%2C%20Morton%27s%20Neuroma&Pain%20Region%20(R)=Inside%20Ankle&Pain%20Region%20(L)=_____&Size=Mens%201&Shoe%20Type=Running%20Shoes&Additional%20Info=1

  // https://www.stridesoles.com/pages/your-fit?quiz_complete=true&variant=40692485259328&checkout[email]=andrewhkim01%40gmail.com&checkout[shipping_address][first_name]=Andrew&Reason=Improving%20Posture&Arch=Flat%20Foot&Pain%20Frequency=After%20a%20long%20day&Condition=Hammer%20Toes&Pain%20Region%20(R)=Heel%2C%20Midfoot&Pain%20Region%20(L)=Midfoot%2C%20Heel&Size=Mens%201&Shoe%20Type=Pickleball%20Shoes&Additional%20Info=123

  */

  class QuizResults extends HTMLElement {
    constructor() {
      super();
      // Configuration
      this.config = {
        defaultVariantId: 40606957371456, // Fallback variant if nothing else is available
        redirectMode: this.shouldRedirect(),
        // localStorage keys
        quizDataKey: 'quiz_data',
        quizTimestampKey: 'quiz_data_timestamp',
        quizVariantKey: 'quiz_variant',
        quizExpiryDays: null, // Set to number of days for expiry, null for no expiry

        // DEPRECATED: These mappings are no longer used since we get the variant from the quiz URL
        // Keeping them here for reference in case we need fallback logic in the future
        // shoeTypeVariants: {
        //   "Sneakers (Also known as 'Tennis Shoes')": this.defaultVariantId,
        //   'Running Shoes': this.defaultVariantId,
        //   'Pickleball Shoes': this.defaultVariantId,
        //   Boots: this.defaultVariantId,
        //   'Dress Shoes': this.defaultVariantId,
        //   'Golf Shoes': this.defaultVariantId,
        //   'Cycling Shoes': this.defaultVariantId,
        //   'Soccer Cleats': this.defaultVariantId,
        //   Heels: this.defaultVariantId,
        //   'Ski Boots': this.defaultVariantId,
        //   'Ice Skates': this.defaultVariantId,
        //   'Ice Skates (Hockey)': this.defaultVariantId,
        //   'Basketball Shoes': this.defaultVariantId,
        // },
        // conditionVariants: {
        //   None: this.defaultVariantId,
        //   'Flat Feet': this.defaultVariantId,
        //   'Plantar Fasciitis': this.defaultVariantId,
        //   Bunions: this.defaultVariantId,
        //   'Hammer Toes': this.defaultVariantId,
        //   "Morton's Neuroma": this.defaultVariantId,
        //   Arthritis: this.defaultVariantId,
        //   'Heel Spurs': this.defaultVariantId,
        //   'Limb-Length Discrepancy': this.defaultVariantId,
        //   Metatarsalgia: this.defaultVariantId,
        //   'Achilles Tendinitis': this.defaultVariantId,
        //   Sesamoiditis: this.defaultVariantId,
        // },

        // REFERENCE: Original variant mappings (if needed for future fallback logic)
        // Shoe type variant mapping (Name from quiz, variantID from shopify)
        // if no product for shoe type, set ID to null
        // shoeTypeVariants: {
        //   "Sneakers (Also known as 'Tennis Shoes')": 40618221404224,
        //   'Running Shoes': 40642850455616,
        //   'Pickleball Shoes': 40692485259328,
        //   Boots: 40612078288960,
        //   'Dress Shoes': 40618185424960,
        //   'Golf Shoes': null,
        //   'Cycling Shoes': null,
        //   'Soccer Cleats': 40692493189184,
        //   Heels: null,
        //   'Ski Boots': null,
        //   'Ice Skates': null,
        //   'Ice Skates (Hockey)': null,
        //   'Basketball Shoes': null,
        // },
        // conditionVariants: {
        //   None: null,
        //   'Flat Feet': 40613653119040,
        //   'Plantar Fasciitis': 40612665458752,
        //   Bunions: 40618012344384,
        //   'Hammer Toes': 40660476035136,
        //   "Morton's Neuroma": null,
        //   Arthritis: 40646980370496,
        //   'Heel Spurs': null,
        //   'Limb-Length Discrepancy': 40659376046144,
        //   Metatarsalgia: 40647329611840,
        //   'Achilles Tendinitis': 40688106537024,
        //   Sesamoiditis: null,
        // },
      };
    }

    shouldRedirect() {
      // Don't redirect in theme customizer
      if (window.Shopify && window.Shopify.designMode) {
        return false;
      }

      // Don't redirect if in preview mode
      if (window.location.search.includes('preview_theme_id')) {
        return false;
      }

      // Don't redirect if parent window exists (iframe context)
      if (window.parent !== window) {
        return false;
      }

      // Default to redirect for normal storefront
      return true;
    }

    connectedCallback() {
      // Log current mode for debugging
      console.log('Quiz Results Mode:', {
        redirectMode: this.config.redirectMode,
        designMode: window.Shopify?.designMode,
        isPreview: window.location.search.includes('preview_theme_id'),
      });

      // Check if user came from quiz completion
      const params = new URLSearchParams(window.location.search);
      const hasQuizCompletion = params.get('quiz_complete') === 'true';

      console.log('Quiz completion check:', {
        hasQuizCompletion,
        fullUrl: window.location.href,
        searchParams: window.location.search,
      });

      if (hasQuizCompletion) {
        // Clear any existing quiz data before storing new data
        console.log('Fresh quiz completion detected - clearing any existing quiz data');
        this.clearStoredQuizData();

        // Get quiz data from URL parameters
        const urlQuizData = this.getLineItemProperties();
        console.log('Raw quiz data extracted from URL:', urlQuizData);
        console.log('Quiz data keys count:', Object.keys(urlQuizData).length);

        // Check for variant parameter in URL and clean it immediately
        const urlVariant = params.get('variant');
        if (urlVariant) {
          // Clean the variant ID right away
          const cleanVariant = this.cleanVariantId(urlVariant);
          console.log('Clean variant found in URL:', cleanVariant);
          this.storeVariant(cleanVariant);
        }

        // Double-check we have actual quiz data
        if (Object.keys(urlQuizData).length === 0) {
          console.warn('quiz_complete=true but no quiz data found in URL');
          console.log('URL search params:', window.location.search);
          console.log('All URL params:', [...params.entries()]);
          this.handleNoQuizData();
          return;
        }

        // We have valid quiz completion - show content and process
        this.showContent();
        console.log('Fresh quiz data from URL (before storage):', urlQuizData);

        // Store the quiz data
        this.storeQuizData(urlQuizData);

        // Verify storage worked
        const verifyStorage = this.getStoredQuizData();
        console.log('Verification - data after storage:', verifyStorage);

        this.displayResults(urlQuizData);
        this.setupCartButton(urlQuizData);
        return;
      }

      // No quiz_complete parameter - redirect immediately (don't check localStorage)
      console.log('No quiz_complete parameter found - redirecting');
      this.handleNoQuizData();
    }

    showContent() {
      // Show the success content (already visible by default, but keeping for consistency)
      const successContent = this.querySelector('.quiz-results__success');
      if (successContent) {
        successContent.style.display = 'block';
      }

      // Ensure fallback content is hidden
      const noDataContent = this.querySelector('.quiz-results__no-data');
      if (noDataContent) {
        noDataContent.style.display = 'none';
      }
    }

    disconnectedCallback() {
      // Clean up if needed
    }

    // localStorage methods
    storeQuizData(quizData) {
      try {
        console.log('Attempting to store quiz data:', quizData);

        // Validate input
        if (!quizData || typeof quizData !== 'object') {
          console.error('Invalid quiz data provided to storeQuizData:', quizData);
          return;
        }

        // Store the quiz data
        const dataString = JSON.stringify(quizData);
        localStorage.setItem(this.config.quizDataKey, dataString);
        console.log('Quiz data JSON string:', dataString);

        // Store timestamp separately for expiry management
        const timestamp = new Date().toISOString();
        localStorage.setItem(this.config.quizTimestampKey, timestamp);

        console.log('Quiz data stored in localStorage successfully:', quizData);
        console.log('Quiz data timestamp:', timestamp);

        // Verify it was stored
        const retrieved = localStorage.getItem(this.config.quizDataKey);
        console.log('Verification - retrieved from localStorage:', retrieved);
      } catch (error) {
        console.error('Failed to store quiz data in localStorage:', error);
        console.error('Quiz data that failed to store:', quizData);
      }
    }

    storeVariant(variantId) {
      try {
        localStorage.setItem(this.config.quizVariantKey, variantId);
        console.log('Quiz variant stored in localStorage:', variantId);
      } catch (error) {
        console.error('Failed to store quiz variant in localStorage:', error);
      }
    }

    getStoredVariant() {
      try {
        return localStorage.getItem(this.config.quizVariantKey);
      } catch (error) {
        console.error('Failed to retrieve quiz variant from localStorage:', error);
        return null;
      }
    }

    getStoredQuizData() {
      try {
        // Check if data has expired
        if (this.isQuizDataExpired()) {
          this.clearStoredQuizData();
          return null;
        }

        const storedData = localStorage.getItem(this.config.quizDataKey);
        return storedData ? JSON.parse(storedData) : null;
      } catch (error) {
        console.error('Failed to retrieve quiz data from localStorage:', error);
        return null;
      }
    }

    isQuizDataExpired() {
      if (!this.config.quizExpiryDays) {
        return false; // No expiry set
      }

      try {
        const timestamp = localStorage.getItem(this.config.quizTimestampKey);
        if (!timestamp) {
          return true; // No timestamp means data is invalid
        }

        const storedDate = new Date(timestamp);
        const now = new Date();
        const daysDiff = (now - storedDate) / (1000 * 60 * 60 * 24);

        return daysDiff > this.config.quizExpiryDays;
      } catch (error) {
        console.error('Error checking quiz data expiry:', error);
        return true; // Assume expired on error
      }
    }

    clearStoredQuizData() {
      try {
        localStorage.removeItem(this.config.quizDataKey);
        localStorage.removeItem(this.config.quizTimestampKey);
        localStorage.removeItem(this.config.quizVariantKey);
        console.log('Quiz data and variant cleared from localStorage');
      } catch (error) {
        console.error('Failed to clear quiz data from localStorage:', error);
      }
    }

    // Method to manually set expiry (call this if you want to enable expiry later)
    setQuizDataExpiry(days) {
      this.config.quizExpiryDays = days;
      console.log(`Quiz data expiry set to ${days} days`);
    }

    // Method to get quiz data for external use (e.g., cart APIs)
    getQuizDataForCart() {
      const quizData = this.getStoredQuizData();
      if (!quizData) {
        console.warn('No quiz data available for cart');
        return {};
      }

      // Parse shoe types to get the full list
      const shoeTypes = this.parseShoeTypes(quizData);
      return {
        lineItemProperties: this.formatAsLineItemProperties(quizData, shoeTypes),
        orderAttributes: this.formatAsOrderAttributes(quizData, shoeTypes),
      };
    }

    handleNoQuizData() {
      if (!this.config.redirectMode) {
        // In design mode - show current content without redirecting
        console.log('Design mode: Not redirecting, showing current content');
        return;
      }

      // Get fallback URL from section settings or default
      const fallbackUrl = this.getAttribute('data-fallback-url') || '/pages/quiz';

      console.log(`No quiz data found. Showing blank screen and redirecting to: ${fallbackUrl}`);

      // Hide success content and show blank fallback
      const successContent = this.querySelector('.quiz-results__success');
      const noDataContent = this.querySelector('.quiz-results__no-data');

      if (successContent) successContent.style.display = 'none';
      if (noDataContent) noDataContent.style.display = 'block';

      // Redirect after a short delay to allow for smooth transition
      setTimeout(() => {
        window.location.href = fallbackUrl;
      }, 100);
    }

    displayResults(lineItemProperties) {
      // Optional: You could display the quiz results somewhere on the page
      // For now, we'll just log them for debugging
      console.log('Quiz results:', lineItemProperties);

      // If you want to show the quiz results on the page, you could add them here
      // For example, adding a summary section or updating existing content
    }

    setupCartButton(lineItemProperties) {
      const button = this.querySelector('#quiz-results-add-to-cart-btn');
      if (!button) return;

      // In theme customizer, make button non-functional
      if (window.Shopify?.designMode) {
        button.addEventListener('click', (e) => {
          e.preventDefault();
          alert('This button adds personalized orthotics to cart in the live store.');
        });
        return;
      }

      // Setup cart add functionality
      button.addEventListener('click', (e) => {
        e.preventDefault();
        this.addToCart(lineItemProperties, button);
      });

      console.log('Cart button setup with quiz data:', lineItemProperties);
    }

    /**
     * Add quiz-recommended product to cart
     *
     * Uses the variant ID from the URL to add the product to the cart.
     * Conditions on shoe type / condition moved to typeform.
     * - The quiz generates a URL with the correct variant ID in the `variant` parameter
     * - We simply use that variant from the URL (or from localStorage if returning user)
     * - Fallback to defaultVariantId only if no variant is found anywhere
     *
     * @param {Object} lineItemProperties - Quiz data from URL parameters
     * @param {HTMLElement} button - The "Add to Cart" button element
     */
    async addToCart(lineItemProperties, button) {
      // Get original button text for restoration on error
      const originalText = button.querySelector('.btn-primary__text')?.textContent || window.variantStrings.addToCart;

      // Disable button and show loading state
      this.setButtonState(button, 'Adding...', true);

      try {
        // STEP 1: Get the variant ID from URL or localStorage
        // Priority: URL param > stored variant > default
        const params = new URLSearchParams(window.location.search);
        const urlVariant = params.get('variant');
        const storedVariant = this.getStoredVariant();

        // Clean the variant ID (remove query params, convert to integer)
        let selectedVariantId = urlVariant || storedVariant || this.config.defaultVariantId;
        selectedVariantId = this.cleanVariantId(selectedVariantId);

        console.log('=== ADD TO CART: Variant Selection ===');
        console.log('URL variant:', urlVariant);
        console.log('Stored variant:', storedVariant);
        console.log('Selected variant (cleaned):', selectedVariantId);

        // STEP 2: Parse shoe types for formatting properties (not for variant selection)
        const shoeTypes = this.parseShoeTypes(lineItemProperties);
        console.log('Shoe types (for properties only):', shoeTypes);

        // STEP 3: Format quiz data for cart
        // Line item properties = attached to each product in cart
        // Order attributes = attached to the entire order
        const lineItemPropertiesFormatted = this.formatAsLineItemProperties(lineItemProperties, shoeTypes);
        const orderAttributesFormatted = this.formatAsOrderAttributes(lineItemProperties, shoeTypes);

        console.log('=== ADD TO CART: Formatted Data ===');
        console.log('Line item properties:', lineItemPropertiesFormatted);
        console.log('Order attributes:', orderAttributesFormatted);

        // STEP 4: Clear the entire cart (items + order attributes)
        console.log('=== ADD TO CART: Clearing Cart ===');
        await this.clearCart();

        // STEP 5: Prepare cart data with the selected variant
        const cartItems = [
          {
            id: selectedVariantId,
            quantity: 1,
            properties: lineItemPropertiesFormatted,
          },
        ];

        const cartData = {
          items: cartItems,
          attributes: orderAttributesFormatted,
        };

        console.log('=== ADD TO CART: Final Cart Data ===');
        console.log('Cart data to add:', cartData);

        // Publish cart add start event (for analytics/tracking)
        if (typeof publish === 'function') {
          publish('cart:add:start', { items: cartData.items });
        }

        // STEP 6: Make the cart add request to Shopify
        const response = await fetch(`${window.shopUrl + window.routes.cart_add_url}.js`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(cartData),
        });

        console.log('=== ADD TO CART: Response ===');
        console.log('Response status:', response.status);

        // Parse the response
        const responseText = await response.text();
        console.log('Response text (first 200 chars):', responseText.substring(0, 200));

        let result;
        try {
          result = JSON.parse(responseText);
        } catch (parseError) {
          console.error('Failed to parse response as JSON:', parseError);
          console.error('Full response text:', responseText);
          throw new Error(`Server returned invalid response. Status: ${response.status}`);
        }

        // Handle error responses from Shopify
        if (!response.ok) {
          if (result.description) {
            throw new Error(result.description);
          } else if (result.message) {
            throw new Error(result.message);
          } else {
            throw new Error(`Cart add failed: ${response.status}`);
          }
        }

        console.log('Successfully added to cart:', result);

        // STEP 7: Show success state and redirect to cart
        this.setButtonState(button, 'Added! Redirecting...', true);

        // Publish cart add success event (for analytics/tracking)
        if (typeof publish === 'function') {
          publish('cart:add:success', { items: result.items || result });
        }

        // Redirect to cart page after short delay
        setTimeout(() => {
          window.location.href = window.routes.cart_url;
        }, 500);
      } catch (error) {
        console.error('=== ADD TO CART: Error ===');
        console.error('Error adding to cart:', error);

        // Publish cart add error event (for analytics/tracking)
        if (typeof publish === 'function') {
          publish('cart:add:error', { error: error.message });
        }

        // Handle specific error cases using Shopify localized strings
        if (error.message.includes('sold out') || error.message.includes('already sold out')) {
          this.setButtonState(button, window.variantStrings.soldOut, true);
        } else if (error.message.includes("can't add more")) {
          this.setButtonState(button, window.cartStrings.quantityError.replace('[quantity]', '1'), true);
          // Re-enable button after 3 seconds for quantity errors
          setTimeout(() => {
            this.setButtonState(button, originalText, false);
          }, 3000);
        } else {
          this.setButtonState(button, 'Error - Try Again', false);
          // Re-enable button after 2 seconds for generic errors
          setTimeout(() => {
            this.setButtonState(button, originalText, false);
          }, 2000);
        }
      }
    }

    /**
     * Clear the entire Shopify cart including items and order attributes
     *
     * This is a two-step process:
     * 1. Clear all cart items using cart/clear.js endpoint
     * 2. Clear all order attributes by setting them to empty strings
     *
     * Note: We don't throw errors here because we want to proceed with adding
     * the new quiz product even if clearing fails
     */
    async clearCart() {
      try {
        console.log('Clearing entire cart...');

        // STEP 1: Clear all cart items using cart clear endpoint
        const clearResponse = await fetch(`${window.shopUrl + window.routes.cart_clear_url}.js`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!clearResponse.ok) {
          throw new Error(`Failed to clear cart items: ${clearResponse.status}`);
        }

        const clearResult = await clearResponse.json();
        console.log('Cart items cleared successfully:', clearResult);

        // STEP 2: Clear all order attributes specifically
        // Get current cart to see what attributes exist
        const cartResponse = await fetch(`${window.shopUrl + window.routes.cart_url}.js`);
        const cart = await cartResponse.json();

        console.log('Current cart attributes after item clearing:', cart.attributes);

        // If there are still attributes, clear them
        if (cart.attributes && Object.keys(cart.attributes).length > 0) {
          console.log('Clearing remaining cart attributes...');

          // Create an object to clear all existing attributes by setting them to empty strings
          const attributesToClear = {};
          Object.keys(cart.attributes).forEach((key) => {
            attributesToClear[key] = '';
          });

          console.log('Attributes to clear:', attributesToClear);

          // Update cart with cleared attributes
          const clearAttributesResponse = await fetch(`${window.shopUrl + window.routes.cart_update_url}.js`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              attributes: attributesToClear,
            }),
          });

          if (!clearAttributesResponse.ok) {
            throw new Error(`Failed to clear cart attributes: ${clearAttributesResponse.status}`);
          }

          const clearAttributesResult = await clearAttributesResponse.json();
          console.log('Cart attributes cleared successfully:', clearAttributesResult.attributes);
        } else {
          console.log('No cart attributes to clear');
        }

        console.log('Complete cart clearing finished successfully');
      } catch (error) {
        console.error('Error clearing cart:', error);
        // Don't throw here - we still want to proceed with adding the new quiz data
        // The worst case is that old items/attributes remain, which is better than failing completely
      }
    }

    // DEPRECATED METHODS (no longer used but kept for reference)
    // These methods were part of the old condition/shoe-type variant selection logic

    // getVariantForCondition(condition) {
    //   const variantId = this.config.conditionVariants[condition];
    //   if (!variantId) {
    //     console.warn(`No variant mapping found for condition: "${condition}"`);
    //     console.log('Available conditions:', Object.keys(this.config.conditionVariants));
    //   }
    //   return variantId || null;
    // }

    // parseConditions(lineItemProperties) {
    //   const conditionValue = lineItemProperties['Condition'] || lineItemProperties['condition'];
    //   if (!conditionValue) {
    //     return null;
    //   }
    //   return conditionValue
    //     .split(',')
    //     .map((condition) => condition.trim())
    //     .filter((condition) => condition.length > 0);
    // }

    // getVariantForShoeType(shoeType) {
    //   const variantId = this.config.shoeTypeVariants[shoeType];
    //   if (!variantId) {
    //     console.warn(`No variant mapping found for shoe type: "${shoeType}"`);
    //     console.log('Available shoe types:', Object.keys(this.config.shoeTypeVariants));
    //   }
    //   return variantId || null;
    // }

    /**
     * Clean variant ID by removing query parameters and converting to integer
     *
     * @param {string|number} variantId - Raw variant ID (may contain query params)
     * @returns {number} Clean variant ID as integer
     */
    cleanVariantId(variantId) {
      if (typeof variantId === 'string') {
        // Remove any query parameters or fragments
        const cleaned = variantId.split('?')[0].split('#')[0];
        return parseInt(cleaned);
      }
      return variantId;
    }

    /**
     * Parse shoe types from line item properties
     * Used for formatting properties only (not for variant selection)
     *
     * @param {Object} lineItemProperties - Quiz data object
     * @returns {Array|null} Array of shoe type strings or null
     */
    parseShoeTypes(lineItemProperties) {
      const shoeTypeValue = lineItemProperties['Shoe Type'] || lineItemProperties['shoe_type'];

      if (!shoeTypeValue) {
        return null;
      }

      // Split by comma and clean up each type
      return shoeTypeValue
        .split(',')
        .map((type) => type.trim())
        .filter((type) => type.length > 0);
    }

    /**
     * Format quiz data as LINE ITEM PROPERTIES
     *
     * Line item properties are attached to individual cart items/products
     * They appear in order confirmation emails and admin orders
     *
     * @param {Object} lineItemProperties - Raw quiz data from URL
     * @param {Array|null} shoeTypes - Parsed shoe types array
     * @returns {Object} Formatted properties object
     */
    formatAsLineItemProperties(lineItemProperties, shoeTypes = null) {
      const cartProperties = {};

      // Convert quiz data to proper format for line item properties
      Object.keys(lineItemProperties).forEach((key) => {
        // Skip variant_id as it's handled separately
        if (key === 'variant_id') return;

        // Format key: capitalize first letter, replace underscores with spaces
        let formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');

        // Special handling for shoe types
        if (key === 'Shoe Type') {
          formattedKey = 'Shoe Type';
          cartProperties[formattedKey] = shoeTypes ? shoeTypes.join(', ') : lineItemProperties[key];
        } else {
          cartProperties[formattedKey] = lineItemProperties[key];
        }
      });

      console.log('Line item properties formatted:', cartProperties);
      return cartProperties;
    }

    /**
     * Format quiz data as ORDER ATTRIBUTES
     *
     * Order attributes are attached to the entire order (not individual items)
     * They appear in order confirmation emails, admin orders, and can be used
     * for order processing/fulfillment logic
     *
     * @param {Object} lineItemProperties - Raw quiz data from URL
     * @param {Array|null} shoeTypes - Parsed shoe types array
     * @returns {Object} Formatted attributes object
     */
    formatAsOrderAttributes(lineItemProperties, shoeTypes = null) {
      const orderAttributes = {};

      // Convert quiz data to order attributes with clean, simple names
      Object.keys(lineItemProperties).forEach((key) => {
        // Skip variant_id as it's handled separately
        if (key === 'variant_id') return;

        let value;
        let formattedKey;

        if (key === 'Shoe Type') {
          // Special handling for shoe types - include all selected types in order attributes
          value = shoeTypes ? shoeTypes.join(', ') : lineItemProperties[key];
          formattedKey = 'Shoe Type';
        } else {
          // Standard formatting - capitalize first letter, replace underscores with spaces
          formattedKey = key.charAt(0).toUpperCase() + key.slice(1).replace(/_/g, ' ');
          value = lineItemProperties[key];
        }

        // Include ALL values in order attributes (don't filter out placeholders)
        if (value && value.toString().trim() !== '') {
          orderAttributes[formattedKey] = value;
        }
      });

      console.log('Order attributes formatted:', orderAttributes);
      return orderAttributes;
    }

    // Legacy method for backwards compatibility
    formatPropertiesForCart(lineItemProperties) {
      const shoeTypes = this.parseShoeTypes(lineItemProperties);
      return this.formatAsLineItemProperties(lineItemProperties, shoeTypes);
    }

    /**
     * Update button visual state (text, disabled state, opacity)
     *
     * @param {HTMLElement} button - Button element to update
     * @param {string} text - Text to display in button
     * @param {boolean} disabled - Whether button should be disabled
     */
    setButtonState(button, text, disabled) {
      if (!button) return;

      const textElements = button.querySelectorAll('.btn-primary__text');
      textElements.forEach((el) => {
        el.textContent = text;
      });

      button.disabled = disabled;
      if (disabled) {
        button.style.opacity = '0.6';
        button.style.cursor = 'not-allowed';
      } else {
        button.style.opacity = '1';
        button.style.cursor = 'pointer';
      }
    }

    /**
     * Parse quiz data from URL parameters
     *
     * Extracts all quiz answers from URL query parameters, excluding
     * control parameters like 'variant', 'quiz_complete', UTM params, etc.
     *
     * Also handles malformed URLs with multiple '?' characters
     *
     * @returns {Object} Quiz data object with cleaned values
     */
    getLineItemProperties() {
      // Handle malformed URLs with multiple ? characters
      let searchString = window.location.search;

      // If there are multiple ? characters, treat everything after the first one as query params
      if (searchString.includes('?')) {
        const parts = window.location.href.split('?');
        if (parts.length > 2) {
          // Reconstruct the search string by joining all parts after the first
          searchString = '?' + parts.slice(1).join('&');
          console.log('Fixed malformed URL search string:', searchString);
        }
      }

      const params = new URLSearchParams(searchString);
      const data = {};

      // Exclude parameters that are not line item properties
      const excludedParams = [
        'quiz_complete', // Control parameter - not a line item property
        'variant', // Variant handled separately
        'storefront',
        'pairs',
        'checkout',
        'checkout_url',
        'debug',
        'quantity',
        '_ga',
        '_gid',
        'utm_source',
        'utm_medium',
        'utm_campaign',
        'utm_term',
        'utm_content',
        'fbclid',
        'gclid',
        'cart_link_id',
        'preview_theme_id',
        'pb', // Shopify preview params
      ];

      for (let [key, value] of params.entries()) {
        if (
          !excludedParams.includes(key) &&
          !key.startsWith('checkout[') &&
          !key.startsWith('utm_') &&
          !key.startsWith('_')
        ) {
          const decodedValue = decodeURIComponent(value);

          // Skip empty values and placeholder values (underscores)
          if (decodedValue && decodedValue.trim() !== '' && !/^_+(\s+_+)*$/.test(decodedValue.trim())) {
            data[key] = decodedValue;
          }
          // If it's empty or a placeholder, we simply don't add it to data
        }
      }

      console.log('Parsed quiz data:', data);
      return data;
    }
  }

  // Make QuizResults globally accessible for external cart integration
  window.QuizResults = QuizResults;
  window.customElements.define('quiz-results', QuizResults);

  // Helper functions for external use (e.g., cart drawer, other scripts)

  /**
   * Get stored quiz data from localStorage
   * @returns {Object|null} Quiz data object or null if not found
   */
  window.getQuizData = function () {
    const quizElement = document.querySelector('quiz-results');
    return quizElement ? quizElement.getStoredQuizData() : null;
  };

  /**
   * Get quiz data formatted for cart (both line item properties and order attributes)
   * @returns {Object} Object with lineItemProperties and orderAttributes
   */
  window.getQuizDataForCart = function () {
    const quizElement = document.querySelector('quiz-results');
    return quizElement ? quizElement.getQuizDataForCart() : {};
  };

  /**
   * Get stored variant ID from localStorage
   * @returns {string|null} Variant ID or null if not found
   */
  window.getQuizVariant = function () {
    const quizElement = document.querySelector('quiz-results');
    return quizElement ? quizElement.getStoredVariant() : null;
  };

  /**
   * Store variant ID in localStorage
   * @param {string|number} variantId - Variant ID to store
   */
  window.setQuizVariant = function (variantId) {
    const quizElement = document.querySelector('quiz-results');
    if (quizElement) {
      quizElement.storeVariant(variantId);
    }
  };

  /**
   * Clear all quiz data from localStorage
   */
  window.clearQuizData = function () {
    const quizElement = document.querySelector('quiz-results');
    if (quizElement) {
      quizElement.clearStoredQuizData();
    }
  };
{% endjavascript %}

{% schema %}
{
  "name": "BUY AGAIN: Your fit",
  "class": "section section-your-fit",
  "settings": [
    {
      "type": "header",
      "content": "Dev mode"
    },
    {
      "type": "header",
      "content": "Your fit page"
    },
    {
      "type": "paragraph",
      "content": "To edit steps, see blocks"
    },
    {
      "type": "image_picker",
      "id": "avatar",
      "label": "Avatar"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "label": "Title",
      "default": "You're only one step away..."
    },
    {
      "type": "inline_richtext",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "This is what happens next:"
    },
    {
      "type": "inline_richtext",
      "id": "button_label",
      "label": "Button label",
      "default": "Let's Go"
    },
    {
      "type": "header",
      "content": "Redirect / fallback"
    },
    {
      "type": "url",
      "id": "fallback_redirect_url",
      "label": "Fallback redirect url"
    }
  ],
  "blocks": [
    {
      "type": "step",
      "name": "Step",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon"
        },
        {
          "type": "inline_richtext",
          "id": "title",
          "label": "Title",
          "default": "Place your order online"
        },
        {
          "type": "inline_richtext",
          "id": "subtitle",
          "label": "Subtitle",
          "default": "Take the first step towards your pain-free life"
        }
      ]
    }
  ]
}
{% endschema %}
