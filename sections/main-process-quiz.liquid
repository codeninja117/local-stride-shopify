{%- if section.settings.product != blank -%}
  {%- assign default_variant_id = section.settings.product.selected_or_first_available_variant.id -%}
{%- else -%}
  {%- assign default_variant_id = '40563425738816' -%}
{%- endif -%}

<!-- Load Typeform SDK -->
<script src="https://embed.typeform.com/next/embed.js"></script>

<!-- Typeform Container -->
<div
  id="typeform-quiz"
  data-tf-widget="Gq49LLpK"
  {% comment %} data-tf-hidden="variant_id={{ default_variant_id }}" {% endcomment %}
  data-tf-hidden="variant={{default_variant_id}}"
  style="width:100%;height:500px"
></div>
{% comment %}
  <script>
    // 1. CONFIGURATION ==============================================
    const DEBUG_MODE = true;
    const COOKIE_EXPIRY_DAYS = 7;

    // 2. INITIALIZATION =============================================
    document.addEventListener('DOMContentLoaded', () => {
      const urlParams = new URLSearchParams(window.location.search);
      const variantId = urlParams.get('variant') || '{{ default_variant_id }}';

      if (window.tf) {
        setupTypeformListeners(variantId);
      } else {
        console.error('Typeform SDK failed to load');
      }
    });

    // 3. TYPEFORM EVENT HANDLING ====================================
    function setupTypeformListeners(variantId) {
      window.addEventListener('message', (event) => {
        if (!event.data || typeof event.data !== 'object') return;

        // Debug logging
        if (DEBUG_MODE) console.log('Typeform Event:', event.data.type, event.data);

        // Form Ready Event
        if (event.data.type === 'form-ready') {
          setCookie(
            'quiz_started',
            JSON.stringify({
              variant_id: variantId,
              timestamp: new Date().toISOString(),
            }),
          );
        }

        // Form Submit Event - MAIN ANSWER PROCESSING
        if (event.data.type === 'form-submit') {
          processQuizAnswers(variantId, event.response || {});
        }
      });
    }

    // 4. ANSWER PROCESSING ===========================================
    function processQuizAnswers(variantId, response) {
      // Extract answers from Typeform response
      const answers = {};
      if (response.answers) {
        response.answers.forEach((answer) => {
          const key = answer.field?.ref || answer.field?.title?.replace(/\s+/g, '_').toLowerCase() || `q_${Date.now()}`;
          const value = answer.text || answer.value || JSON.stringify(answer.choices?.labels) || '';
          answers[key] = value;
        });
      }

      // Prepare cart data with answers as properties
      const cartData = {
        id: variantId,
        quantity: 1,
        properties: {
          ...answers,
          quiz_completed: new Date().toISOString(),
          quiz_id: response.form_id,
        },
      };

      // Save to cookies (two ways)
      setCookie('quiz_answers_raw', JSON.stringify(answers)); // Raw answers
      setCookie('quiz_cart_data', JSON.stringify(cartData)); // Cart-ready format

      // Add to cart
      addToCartWithRetry(cartData);
    }

    // 5. CART OPERATIONS ============================================
    function addToCartWithRetry(cartData) {
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData),
      })
        .then((response) => {
          if (!response.ok) throw new Error('Cart API Error');
          return response.json();
        })
        .then((cart) => {
          if (DEBUG_MODE) console.log('Cart Update Success:', cart);
          verifyCartProperties(cartData.properties);
        })
        .catch((error) => {
          console.error('Cart Error:', error);
          fallbackCartAdd(cartData);
        });
    }

    function verifyCartProperties(expectedProps) {
      fetch('/cart.js')
        .then((res) => res.json())
        .then((cart) => {
          const lastItem = cart.items[cart.items.length - 1];
          if (DEBUG_MODE) console.log('Cart Properties Verification:', lastItem.properties);

          if (!lastItem.properties || Object.keys(lastItem.properties).length === 0) {
            console.warn('Properties not saved - using cookie fallback');
            applyPropertiesFromCookie();
          } else {
            redirectToCheckout();
          }
        });
    }

    function applyPropertiesFromCookie() {
      const cookieData = getCookie('quiz_cart_data');
      if (cookieData) {
        try {
          const { id, properties } = JSON.parse(cookieData);
          const formData = new FormData();
          formData.append('id', id);
          formData.append('quantity', 1);

          // Append each property
          Object.entries(properties).forEach(([key, value]) => {
            formData.append(`properties[${key}]`, value);
          });

          fetch('/cart/add.js', {
            method: 'POST',
            body: formData,
          }).then(() => redirectToCheckout());
        } catch (e) {
          console.error('Cookie parse error:', e);
          redirectToCheckout();
        }
      }
    }

    function fallbackCartAdd(cartData) {
      // Build classic form submit as last resort
      const form = document.createElement('form');
      form.method = 'post';
      form.action = '/cart/add';

      // Add variant and quantity
      const idInput = document.createElement('input');
      idInput.type = 'hidden';
      idInput.name = 'id';
      idInput.value = cartData.id;
      form.appendChild(idInput);

      const qtyInput = document.createElement('input');
      qtyInput.type = 'hidden';
      qtyInput.name = 'quantity';
      qtyInput.value = '1';
      form.appendChild(qtyInput);

      // Add properties
      Object.entries(cartData.properties).forEach(([key, value]) => {
        const propInput = document.createElement('input');
        propInput.type = 'hidden';
        propInput.name = `properties[${key}]`;
        propInput.value = value;
        form.appendChild(propInput);
      });

      document.body.appendChild(form);
      form.submit();
    }

    // 6. UTILITY FUNCTIONS ==========================================
    function setCookie(name, value) {
      const expiry = new Date();
      expiry.setDate(expiry.getDate() + COOKIE_EXPIRY_DAYS);

      const cookieValue = encodeURIComponent(JSON.stringify(value));
      const cookieString = `${name}=${cookieValue};expires=${expiry.toUTCString()};path=/;Secure;SameSite=Lax`;

      document.cookie = cookieString;
      if (DEBUG_MODE) console.log('Cookie Set:', name, value);
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        try {
          return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
        } catch (e) {
          console.error('Cookie parse error:', e);
          return null;
        }
      }
      return null;
    }

    function redirectToCheckout() {
      window.location.href = '/checkout';
    }

    // 7. DEBUGGING TOOLS ============================================
    if (DEBUG_MODE) {
      // Log all cookies on load
      console.log('Current Cookies:', document.cookie.split('; '));

      // Expose functions to console for testing
      window.__debugQuiz = {
        getCookie,
        setCookie,
        simulateSubmit: () => {
          processQuizAnswers('{{ default_variant_id }}', {
            answers: [
              { field: { ref: 'foot_type', title: 'Foot Type' }, text: 'Flat' },
              { field: { ref: 'pain_level', title: 'Pain Level' }, value: '5' },
            ],
            form_id: 'debug_sample',
          });
        },
      };
    }
  </script>
{% endcomment %}

<script>
  const DEBUG_MODE = true;
  const COOKIE_EXPIRY_DAYS = 7;

  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const variantId = urlParams.get('variant') || '{{ default_variant_id }}';

    if (window.tf) {
      setupTypeformListeners(variantId);
    } else {
      console.error('Typeform SDK failed to load');
    }
  });

  function setupTypeformListeners(variantId) {
    let isProcessing = false;

    window.addEventListener('message', (event) => {
      if (!event.data || typeof event.data !== 'object') return;

      if (DEBUG_MODE) console.log('Typeform Event:', event.data.type, event.data);

      console.log('!!!!!!!', event);

      if (event.data.type === 'form-ready') {
        setCookie(
          'quiz_started',
          JSON.stringify({
            variant_id: variantId,
            timestamp: new Date().toISOString(),
          }),
        );
      }

      if (event.data.type === 'form-submit' && !isProcessing) {
        isProcessing = true;
        processQuizAnswers(variantId, event.data.response || {});
        setTimeout(() => {
          isProcessing = false;
        }, 1000);
      }
    });
  }

  function processQuizAnswers(variantId, response) {
    if (DEBUG_MODE) console.log('Raw Typeform Response:', response);

    const answers = {};
    if (response.answers && Array.isArray(response.answers)) {
      response.answers.forEach((answer) => {
        const key = answer.field?.ref || answer.field?.title?.replace(/\s+/g, '_').toLowerCase() || `q_${Date.now()}`;
        const value = answer.text || answer.value || JSON.stringify(answer.choices?.labels) || '';
        answers[key] = value;
      });
    } else {
      console.warn('No valid answers found in response:', response);
    }

    const cartData = {
      id: variantId,
      quantity: 1,
      properties: {
        ...answers,
        quiz_completed: new Date().toISOString(),
        quiz_id: response.form_id || 'unknown',
      },
    };

    setCookie('quiz_answers_raw', JSON.stringify(answers));
    setCookie('quiz_cart_data', JSON.stringify(cartData));

    if (DEBUG_MODE) {
      console.log('Cookies after set:', {
        raw: getCookie('quiz_answers_raw'),
        cart: getCookie('quiz_cart_data'),
      });
    }

    addToCartWithRetry(cartData);
  }

  function addToCartWithRetry(cartData) {
    const payload = {
      items: [cartData],
    };

    fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })
      .then((response) => {
        if (!response.ok) throw new Error('Cart API Error: ' + response.status);
        return response.json();
      })
      .then((cart) => {
        if (DEBUG_MODE) console.log('Cart Update Success:', cart);
        verifyCartProperties(cartData.properties, cart);
      })
      .catch((error) => {
        console.error('Cart Error:', error);
        fetch('/cart.js')
          .then((res) => res.json())
          .then((cart) => {
            if (cart.items.length === 0) {
              fallbackCartAdd(cartData);
            } else {
              redirectToCheckout();
            }
          });
      });
  }

  function verifyCartProperties(expectedProps, cart) {
    const lastItem = cart.items[cart.items.length - 1];
    if (DEBUG_MODE) console.log('Cart Properties Verification:', lastItem.properties);

    if (!lastItem.properties || Object.keys(lastItem.properties).length === 0) {
      console.warn('Properties not saved - attempting to update existing item');
      updateCartItemProperties(lastItem.key, expectedProps);
    } else {
      redirectToCheckout();
    }
  }

  function updateCartItemProperties(itemKey, properties) {
    fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        key: itemKey,
        properties: properties,
      }),
    })
      .then((response) => {
        if (!response.ok) throw new Error('Cart Update Error');
        return response.json();
      })
      .then((cart) => {
        if (DEBUG_MODE) console.log('Properties Updated:', cart);
        redirectToCheckout();
      })
      .catch((error) => {
        console.error('Update Error:', error);
        redirectToCheckout();
      });
  }

  function fallbackCartAdd(cartData) {
    const form = document.createElement('form');
    form.method = 'post';
    form.action = '/cart/add';

    const idInput = document.createElement('input');
    idInput.type = 'hidden';
    idInput.name = 'id';
    idInput.value = cartData.id;
    form.appendChild(idInput);

    const qtyInput = document.createElement('input');
    qtyInput.type = 'hidden';
    qtyInput.name = 'quantity';
    qtyInput.value = '1';
    form.appendChild(qtyInput);

    Object.entries(cartData.properties).forEach(([key, value]) => {
      const propInput = document.createElement('input');
      propInput.type = 'hidden';
      propInput.name = `properties[${key}]`;
      propInput.value = value;
      form.appendChild(propInput);
    });

    document.body.appendChild(form);
    form.submit();
  }

  function setCookie(name, value) {
    const expiry = new Date();
    expiry.setDate(expiry.getDate() + COOKIE_EXPIRY_DAYS);

    const cookieValue = encodeURIComponent(JSON.stringify(value));
    const cookieString = `${name}=${cookieValue};expires=${expiry.toUTCString()};path=/;Secure;SameSite=Lax`;
    document.cookie = cookieString;

    if (DEBUG_MODE) console.log('Cookie Set:', name, value);
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) {
      try {
        return JSON.parse(decodeURIComponent(parts.pop().split(';').shift()));
      } catch (e) {
        console.error('Cookie parse error:', e);
        return null;
      }
    }
    return null;
  }

  function redirectToCheckout() {
    window.location.href = '/checkout';
  }

  if (DEBUG_MODE) {
    console.log('Current Cookies:', document.cookie.split('; '));
    window.__debugQuiz = {
      getCookie,
      setCookie,
      simulateSubmit: () => {
        processQuizAnswers('{{ default_variant_id }}', {
          answers: [
            { field: { ref: 'foot_type', title: 'Foot Type' }, text: 'Flat' },
            { field: { ref: 'pain_level', title: 'Pain Level' }, value: '5' },
          ],
          form_id: 'debug_sample',
        });
      },
    };
  }
</script>
{% schema %}
{
  "name": "Process Quiz",
  "settings": [
    {
      "type": "paragraph",
      "content": "Set typeform to redirect to this page. Adds the variant and quiz answers via line item properties to cart, and upon sucess redirects the user to checkout."
    }
  ]
}
{% endschema %}
