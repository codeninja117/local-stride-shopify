{%- comment -%}
  Combines the cart items and cart footer sections into one section.
{%- endcomment -%}
{%- unless settings.cart_type == 'drawer' -%}
  <script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>
{%- endunless -%}

{{ 'quick-add.css' | asset_url | stylesheet_tag }}
<script src="{{ 'quick-add.js' | asset_url }}" defer="defer"></script>

{% style %}
  .section-{{ section.id }}-padding { padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
  padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px; }

  @media screen and (min-width: 768px) { .section-{{ section.id }}-padding { padding-top:
  {{ section.settings.padding_top }}px; padding-bottom: {{ section.settings.padding_bottom }}px; } }

  .main-cart-summary square-placement {
    margin-top: -18px !important;
    text-align: right;
  }

  @media screen and (max-width: 1023px) {
  .main-cart-summary square-placement .mono-light-jewel-afterpay path {
      fill: #FFF !important;
    }
  }
{% endstyle %}

<script>
  // Temporary test code - add to cart page
  window.testCartVariantChange = function (variantId) {
    const cartItem = document.querySelector('.cart-item');
    cartItem.dispatchEvent(
      new CustomEvent('variant-changed', {
        bubbles: true,
        detail: {
          variant: { id: variantId },
        },
      }),
    );
  };
</script>

<div
  id="main-cart"
  data-id="{{ section.id }}"
  class="bg-blue-fitness/10 section-{{ section.id }}-padding main-cart-aug-2025"
>
  <div class="page-width js-contents">
    {% unless section.settings.hide_cart_header %}
      <div class="cart__title-wrapper mb-4 flex items-center justify-center md:mb-8 md:justify-between {% if cart == empty %}hidden{% endif %}">
        <h1 class=" text-2xl font-bold">{{ 'sections.cart.title' | t }}</h1>
        {% unless settings.hide_continue_shopping %}
          <a
            href="{{ routes.all_products_collection_url }}"
            class="hidden border-b border-current text-blue-600 hover:text-blue-800 md:block"
          >
            {{- 'general.continue_shopping' | t -}}
          </a>
        {% endunless %}
      </div>
    {% endunless %}
    {% render 'cart-timer' %}

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-12 lg:gap-6">
      {%- comment -%} Start cart items section {%- endcomment -%}

      <section class="main-cart-items grid gap-10 {% if cart == empty %}max-w-screen-lg mx-auto lg:col-span-12 {% else %}  lg:col-span-7{% endif %}">
        <cart-items class="{% if cart == empty %}is-empty{% else %}{% endif %} isolate block rounded-lg bg-white p-4 shadow-xs">
          <div class="cart__warnings text-center">
            <h1 class="cart__empty-text mb-4 text-xl font-medium">{{ 'sections.cart.empty' | t }}</h1>

            {%- assign continue_shopping_text = 'general.continue_shopping' | t -%}

            {% render 'button', tag: 'a', text: continue_shopping_text, url: routes.root_url, variant: 'primary' %}

            {%- if shop.customer_accounts_enabled and customer == null -%}
              <h2 class="cart__login-title mt-8 mb-2 text-lg font-medium">{{ 'sections.cart.login.title' | t }}</h2>
              <p class="cart__login-paragraph">
                {{ 'sections.cart.login.paragraph_html' | t: link: routes.account_login_url }}
              </p>
            {%- endif -%}
          </div>
          <div class="mx-auto">
            <form action="{{ routes.cart_url }}" class="cart__contents critical-hidden" method="post" id="cart">
              <div class="cart__items" id="main-cart-items" data-id="{{ section.id }}">
                <div class="js-contents">
                  {%- if cart != empty -%}
                    <div class="">
                      <div class="sr-only">
                        {{ 'sections.cart.title' | t }}
                      </div>

                      <!-- Cart header - desktop -->
                      <div class="hidden border-b border-gray-200 pb-3 md:grid md:grid-cols-12">
                        <div class="col-span-6 text-xs font-medium tracking-wider text-gray-500 uppercase">
                          {{ 'sections.cart.headings.product' | t }}
                        </div>
                        <div class="col-span-6 text-right text-xs font-medium tracking-wider text-gray-500 uppercase">
                          {{ 'sections.cart.headings.quantity' | t }}
                        </div>
                      </div>

                      <ul role="list" class="divide-blue-fitness/50 divide-y">
                        {%- for item in cart.items -%}
                          <li
                            class="cart-item flex flex-col gap-4 py-4"
                            id="CartItem-{{ item.index | plus: 1 }}"
                            data-properties="{{ item.properties | json | escape }}"
                          >
                            <div class="grid grid-cols-12 gap-4 md:grid-cols-12">
                              <!-- Product image -->
                              <div class="col-span-4 md:col-span-2">
                                {% if item.image %}
                                  <a href="{{ item.url }}" class="cart-item__link" aria-hidden="true" tabindex="-1">
                                  </a>
                                  <div class="cart-item__image-container aspect-w-1 aspect-h-1 overflow-hidden rounded-md bg-gradient-to-b from-gray-100 to-gray-200">
                                    <img
                                      src="{{ item.image | image_url: width: 300 }}"
                                      class="cart-item__image object-cover"
                                      alt="{{ item.image.alt | escape }}"
                                      loading="lazy"
                                      width="150"
                                      height="{{ 150 | divided_by: item.image.aspect_ratio | ceil }}"
                                    >
                                  </div>
                                {% endif %}
                              </div>

                              <!-- Product details -->
                              <div class="product-details-cart col-span-8 flex flex-col md:col-span-4">
                                <div class="jdgm-widget jdgm-preview-badge" data-id="{{ item.product.id }}">
                                  {{ item.product.metafields.judgeme.badge }}
                                </div>
                                <a
                                  href="{{ item.url }}"
                                  class="cart-item__name text-base font-medium break-words text-gray-900"
                                >
                                  {{- item.product.title | escape -}}
                                </a>

                                {%- comment %} Calculate total discount for this line item {%- endcomment %}
                                {%- assign total_line_discount = 0 -%}
                                {%- if cart.discount_applications.size > 0 -%}
                                  {%- for discount in item.discount_allocations -%}
                                    {%- assign total_line_discount = total_line_discount | plus: discount.amount -%}
                                  {%- endfor -%}
                                {%- endif -%}

                                {%- comment %} Calculate discounted prices {%- endcomment %}
                                {%- assign discounted_original_price = item.original_price
                                  | minus: total_line_discount
                                -%}
                                {%- assign discounted_compare_price = item.variant.compare_at_price
                                  | minus: total_line_discount
                                -%}

                                {%- if total_line_discount > 0 -%}
                                  {%- comment %} Real discount code is active {%- endcomment %}
                                  <div class="mt-1 flex items-center">
                                    {%- if item.variant.compare_at_price
                                      and item.variant.compare_at_price > item.original_price
                                    -%}
                                      {% comment %} Final price {% endcomment %}
                                      <div class="line-item-price text-base font-medium">
                                        {{- discounted_original_price | money -}}
                                      </div>

                                      {%- comment %} Compare at price {%- endcomment %}
                                      <s class="cart-item__compare-price line-item-price mr-2 text-base text-red-500 line-through">
                                        {{- item.variant.compare_at_price | money -}}
                                      </s>
                                    {%- endif -%}
                                  </div>
                                {%- else -%}
                                  {%- comment %} No discount code applied {%- endcomment %}
                                  <div class="mt-1 flex items-center">
                                    <div class="line-item-price text-base font-medium">
                                      {{ item.original_price | money }}
                                    </div>
                                    {%- if item.variant.compare_at_price
                                      and item.variant.compare_at_price > item.original_price
                                    -%}
                                      <s class="cart-item__compare-price line-item-price mr-2 text-base text-red-500 line-through">
                                        {{- item.variant.compare_at_price | money -}}
                                      </s>
                                    {%- endif -%}
                                  </div>
                                {%- endif -%}

                                {%- if item.product.has_only_default_variant == false
                                  or item.properties.size != 0
                                  or item.selling_plan_allocation != null
                                -%}
                                  <dl class="line-item-options mt-2 space-y-1 text-sm text-gray-500">
                                    {%- if item.product.has_only_default_variant == false -%}
                                      {%- for option in item.options_with_values -%}
                                        <div class="flex">
                                          <dt class="mr-1 font-medium">{{ option.name }}:</dt>
                                          <dd>{{ option.value }}</dd>
                                        </div>
                                      {%- endfor -%}
                                    {%- endif -%}
                                  </dl>

                                  <div class="mt-2 flex justify-start">
                                    <cart-remove-button
                                      id="Remove-{{ item.index | plus: 1 }}"
                                      data-index="{{ item.index | plus: 1 }}"
                                      class="text-xs"
                                    >
                                      <a
                                        href="{{ item.url_to_remove }}"
                                        class="button button--tertiary"
                                        aria-label="{{ 'sections.cart.remove_title' | t: title: item.title | escape }}"
                                      >
                                        <span class="svg-wrapper"> Remove </span>
                                      </a>
                                    </cart-remove-button>
                                  </div>

                                  <p class="mt-1 text-sm text-gray-500">
                                    {{ item.selling_plan_allocation.selling_plan.name }}
                                  </p>
                                {%- endif -%}

                                <ul
                                  class="discounts mt-2 space-y-1 text-sm text-green-600"
                                  role="list"
                                  aria-label="{{ 'customer.order.discount' | t }}"
                                >
                                  {%- for discount in item.line_level_discount_allocations -%}
                                    <li class="discounts__discount flex items-center">
                                      <svg
                                        class="mr-1 h-4 w-4"
                                        viewBox="0 0 24 24"
                                        fill="none"
                                        xmlns="http://www.w3.org/2000/svg"
                                      >
                                        <path d="M5 12H19M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                      </svg>
                                      {{ discount.discount_application.title | escape }}
                                    </li>
                                  {%- endfor -%}
                                </ul>
                              </div>

                              {% comment %}
                                {%- comment %} Calculate discounts for all variant options {%- endcomment %}
                                {%- assign variant_discounts = '' -%}
                                {%- assign total_line_discount = 0 -%}

                                {%- if cart.discount_applications.size > 0 -%}
                                  {%- for discount in item.discount_allocations -%}
                                    {%- assign total_line_discount = total_line_discount | plus: discount.amount -%}
                                  {%- endfor -%}
                                {%- endif -%}

                                {%- comment %} Calculate discounted prices for each variant option {%- endcomment %}
                                {%- for option in item.product.options_with_values -%}
                                  {%- if option.name == 'Pairs' -%}
                                    {%- for value in option.values -%}
                                      {%- comment %} Find the variant for this option value {%- endcomment %}
                                      {%- for variant in item.product.variants -%}
                                        {%- if variant.option1 == value -%}
                                          {%- comment %} Calculate discounted price for this variant {%- endcomment %}
                                          {%- assign variant_original_price = variant.price -%}
                                          {%- assign variant_discounted_price = variant_original_price -%}

                                          {%- if total_line_discount > 0 -%}
                                            {%- comment %} Apply proportional discount based on this variant's price vs current item price {%- endcomment %}
                                            {%- assign discount_ratio = total_line_discount
                                              | times: 100
                                              | divided_by: item.original_price
                                            -%}
                                            {%- assign variant_discount = variant_original_price
                                              | times: discount_ratio
                                              | divided_by: 100
                                            -%}
                                            {%- assign variant_discounted_price = variant_original_price
                                              | minus: variant_discount
                                            -%}
                                          {%- endif -%}

                                          {%- comment %} Store the discount info in a string we can parse later {%- endcomment %}
                                          {%- assign variant_info = value
                                            | append: ':'
                                            | append: variant_original_price
                                            | append: ':'
                                            | append: variant_discounted_price
                                          -%}
                                          {%- if variant_discounts == '' -%}
                                            {%- assign variant_discounts = variant_info -%}
                                          {%- else -%}
                                            {%- assign variant_discounts = variant_discounts
                                              | append: '|'
                                              | append: variant_info
                                            -%}
                                          {%- endif -%}
                                          {%- break -%}
                                        {%- endif -%}
                                      {%- endfor -%}
                                    {%- endfor -%}
                                  {%- endif -%}
                                {%- endfor -%}
                              {% endcomment %}

                              {%- comment %} Calculate discounts for all variant options {%- endcomment %}
                              {%- assign variant_discounts = '' -%}

                              {%- comment %} Get discount info from discount applications {%- endcomment %}
                              {%- assign discount_value = 0 -%}
                              {%- assign discount_value_type = '' -%}
                              {%- assign has_discount = false -%}

                              {%- for discount_app in cart.discount_applications -%}
                                {% comment %}
                                  DEBUG: {{ discount_app.title }} - Type: {{ discount_app.value_type }} - Value:
                                  {{ discount_app.value }} - target_type: {{ discount_app.target_type }}
                                {% endcomment %}
                                {%- if discount_app.target_type == 'line_item' -%}
                                  {%- assign discount_value = discount_app.value -%}
                                  {%- assign discount_value_type = discount_app.value_type -%}
                                  {%- assign has_discount = true -%}
                                  {%- break -%}
                                {%- endif -%}
                              {%- endfor -%}

                              {%- comment %} Calculate discounted prices for each variant option {%- endcomment %}
                              {%- for option in item.product.options_with_values -%}
                                {%- if option.name == 'Pairs' -%}
                                  {%- for value in option.values -%}
                                    {%- for variant in item.product.variants -%}
                                      {%- if variant.option1 == value -%}
                                        {%- assign variant_original_price = variant.price -%}
                                        {%- assign variant_discounted_price = variant_original_price -%}

                                        {%- if has_discount -%}
                                          {%- if discount_value_type == 'percentage' -%}
                                            {%- comment %} Apply percentage discount {%- endcomment %}
                                            {%- assign discount_multiplier = 100 | minus: discount_value -%}
                                            {%- assign variant_discounted_price = variant_original_price
                                              | times: discount_multiplier
                                              | divided_by: 100
                                            -%}
                                          {%- elsif discount_value_type == 'fixed_amount' -%}
                                            {%- comment %} Apply fixed amount discount directly (convert dollars to cents) {%- endcomment %}
                                            {%- assign discount_in_cents = discount_value | times: 100 -%}
                                            {%- assign variant_discounted_price = variant_original_price
                                              | minus: discount_in_cents
                                            -%}
                                            {%- if variant_discounted_price < 0 -%}
                                              {%- assign variant_discounted_price = 0 -%}
                                            {%- endif -%}
                                          {%- endif -%}
                                        {%- endif -%}

                                        {%- assign variant_info = value
                                          | append: ':'
                                          | append: variant_original_price
                                          | append: ':'
                                          | append: variant_discounted_price
                                        -%}
                                        {%- if variant_discounts == '' -%}
                                          {%- assign variant_discounts = variant_info -%}
                                        {%- else -%}
                                          {%- assign variant_discounts = variant_discounts
                                            | append: '|'
                                            | append: variant_info
                                          -%}
                                        {%- endif -%}
                                        {%- break -%}
                                      {%- endif -%}
                                    {%- endfor -%}
                                  {%- endfor -%}
                                {%- endif -%}
                              {%- endfor -%}

                              {% comment %} Product Variant Selector {% endcomment %}

                              <fieldset
                                id="CartItemVariantSelect-{{ item.key }}"
                                class="relative col-span-12 h-fit md:col-span-6"
                              >
                                {%- unless item.product.has_only_default_variant -%}
                                  {%- for option in item.product.options_with_values -%}
                                    <legend class="sr-only">
                                      {{ option.name }}
                                    </legend>

                                    <div class="flex flex-wrap gap-2 md:gap-2">
                                      {% render 'line-item-product-variant-options',
                                        product: item.product,
                                        option: option,
                                        item: item,
                                        picker_type: 'button',
                                        variant_discounts: variant_discounts
                                      %}
                                    </div>
                                  {%- endfor -%}
                                {%- endunless -%}

                                {% render 'loading-spinner',
                                  class: 'variant-loading__spinner absolute inset-0 z-10 bg-white/80 flex items-center justify-center hidden'
                                %}
                              </fieldset>
                            </div>

                            {% if item.product.selling_plan_groups.size > 0 %}
                              {% render 'selling-plan-selector', section: section, item: item %}
                            {% endif %}
                          </li>
                        {%- endfor -%}
                      </ul>
                    </div>
                  {%- endif -%}
                </div>
              </div>

              <p class="sr-only" id="cart-live-region-text" aria-live="polite" role="status"></p>
              <p
                class="sr-only"
                id="shopping-cart-line-item-status"
                aria-live="polite"
                aria-hidden="true"
                role="status"
              >
                {{ 'accessibility.loading' | t }}
              </p>
            </form>
          </div>

          {%- comment -%}SHOW CUSTOMIZATIONS {%- endcomment -%}

          {%- liquid
            assign has_gift_card = false
            assign has_orthotics = false

            for item in cart.items
              if item.product.type == 'Gift card'
                assign has_gift_card = true
              elsif item.product.type == 'Orthotics'
                assign has_orthotics = true
              endif
            endfor
          -%}

          {% if cart.attributes.size > 0 and cart != empty %}
            {% if has_gift_card == false or has_orthotics == true %}
              <div class="cart-customizations-wrapper">
                <cart-item-customizations class="relative block">
                  <div class="cart-item__customization bg-blue-fitness/10 rounded-lg p-4">
                    <h3 class="mb-4 flex items-center gap-2 font-semibold">
                      <span class="h-6 w-6">{{ 'icon-sparkle.svg' | inline_asset_content }}</span>
                      Your Customizations
                    </h3>
                    <div class="cart-customizations">
                      {% comment %} <ul class="relative -mx-4 gap-2 px-4 md:columns-2"> {% endcomment %}
                      <ul class="relative -mx-4 px-4 md:columns-2">
                        {% comment %} Helper to check if value is not empty and not a placeholder {% endcomment %}
                        {% assign placeholder_pattern = '_____' %}
                        {% assign empty_value = '_____' %}

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">
                            Reason for seeking care:
                          </dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes.Reason
                              and cart.attributes.Reason != blank
                              and cart.attributes.Reason != placeholder_pattern
                            %}
                              {{ cart.attributes.Reason }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Arch Type:</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes.Arch
                              and cart.attributes.Arch != blank
                              and cart.attributes.Arch != placeholder_pattern
                            %}
                              {{ cart.attributes.Arch }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Pain Frequency:</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes['Pain Frequency']
                              and cart.attributes['Pain Frequency'] != blank
                              and cart.attributes['Pain Frequency'] != placeholder_pattern
                            %}
                              {{ cart.attributes['Pain Frequency'] }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Condition:</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes.Condition
                              and cart.attributes.Condition != blank
                              and cart.attributes.Condition != placeholder_pattern
                            %}
                              {{ cart.attributes.Condition }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Pain Region (L):</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes['Pain Region (L)']
                              and cart.attributes['Pain Region (L)'] != blank
                              and cart.attributes['Pain Region (L)'] != placeholder_pattern
                            %}
                              {{ cart.attributes['Pain Region (L)'] }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Pain Region (R):</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes['Pain Region (R)']
                              and cart.attributes['Pain Region (R)'] != blank
                              and cart.attributes['Pain Region (R)'] != placeholder_pattern
                            %}
                              {{ cart.attributes['Pain Region (R)'] }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Size:</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% assign size_check = cart.attributes.Size | strip %}
                            {% unless size_check == blank
                              or size_check == placeholder_pattern
                              or size_check contains '_____'
                            %}
                              {{ cart.attributes.Size }}
                            {% else %}
                              {{ empty_value }}
                            {% endunless %}
                          </dd>
                        </li>

                        <li class="block break-inside-avoid">
                          <dt class="inline text-sm font-semibold whitespace-nowrap text-gray-500">Additional Info:</dt>
                          <dd class="inline text-sm text-gray-900">
                            {% if cart.attributes['Additional Info']
                              and cart.attributes['Additional Info'] != blank
                              and cart.attributes['Additional Info'] != placeholder_pattern
                            %}
                              {{ cart.attributes['Additional Info'] }}
                            {% else %}
                              {{ empty_value }}
                            {% endif %}
                          </dd>
                        </li>

                        {% comment %}
                          <li class="block break-inside-avoid pt-1">
                            <shoe-type-cart-updater>
                              {% comment %} <h4 class="mb-3 text-sm font-semibold text-gray-700">Shoe Types:</h4> {% endcomment %}

                              {%- comment -%} Define shoe type options {%- endcomment -%}
                              {% assign shoe_options = "Sneakers (Also known as 'Tennis Shoes'),Running Shoes,Boots,Dress Shoes,Pickleball Shoes,Golf Shoes,Cycling Shoes,Basketball Shoes"
                                | split: ','
                              %}

                              {%- comment -%} Determine current pairs count from cart items {%- endcomment -%}
                              {% assign current_pairs = 1 %}
                              {% for item in cart.items %}
                                {% assign variant_title = item.variant.title %}
                                {% assign pairs_match = variant_title | split: ' ' | first %}
                                {% assign current_pairs = pairs_match | plus: 0 %}
                                {% break %}
                              {% endfor %}

                              <div class="space-y-1">
                                {%- comment -%} Pair 1 Selector - Always show {%- endcomment -%}
                                <div class="shoe-type-dropdown flex items-center gap-1">
                                  {% comment %} <label class="min-w-[60px] text-sm font-medium text-gray-700">Pair 1:</label> {% endcomment %}
                                  <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 1:</label>
                                  <select
                                    class="w-32 rounded border border-gray-300 bg-white px-2 text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    data-pair="1"
                                    name="shoe_type_1"
                                  >
                                    <option value="" disabled>Select shoe type...</option>
                                    {% for option in shoe_options %}
                                      <option
                                        value="{{ option }}"
                                        {% assign option_key = option | split: ' ' | first | downcase %}
                                        {% assign cart_key = cart.attributes['Shoe Type']
                                          | split: ' '
                                          | first
                                          | downcase
                                        %}
                                        {% if option_key == cart_key %}
                                          selected
                                        {% endif %}
                                      >
                                        {{ option }}
                                      </option>
                                    {% endfor %}
                                  </select>
                                </div>

                                {%- comment -%} Pair 2 Selector - Show only if 2+ pairs {%- endcomment -%}
                                {% if current_pairs >= 2 %}
                                  <div class="shoe-type-dropdown flex items-center gap-1">
                                    {% comment %} <label class="min-w-[60px] text-sm font-medium text-gray-700">Pair 2:</label> {% endcomment %}
                                    <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 2:</label>
                                    <select
                                      class="w-32 rounded border border-gray-300 bg-white px-2  text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                      data-pair="2"
                                      name="shoe_type_2"
                                    >
                                      <option value="">Select shoe type...</option>
                                      {% for option in shoe_options %}
                                        <option
                                          value="{{ option }}"
                                          {% assign option_key = option | split: ' ' | first | downcase %}
                                          {% assign cart_key = cart.attributes['Shoe Type 2']
                                            | split: ' '
                                            | first
                                            | downcase
                                          %}
                                          {% if option_key == cart_key %}
                                            selected
                                          {% endif %}
                                        >
                                          {{ option }}
                                        </option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                {% endif %}

                                {%- comment -%} Pair 3 Selector - Show only if 3 pairs {%- endcomment -%}
                                {% if current_pairs >= 3 %}
                                  <div class="shoe-type-dropdown flex items-center gap-1">
                                    {% comment %} <label class="min-w-[60px] text-sm font-medium text-gray-700">Pair 3:</label> {% endcomment %}
                                    <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 3:</label>
                                    <select
                                      class="w-32 rounded border border-gray-300 bg-white px-2 text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                      data-pair="3"
                                      name="shoe_type_3"
                                    >
                                      <option value="">Select shoe type...</option>
                                      {% for option in shoe_options %}
                                        <option
                                          value="{{ option }}"
                                          {% assign option_key = option | split: ' ' | first | downcase %}
                                          {% assign cart_key = cart.attributes['Shoe Type 3']
                                            | split: ' '
                                            | first
                                            | downcase
                                          %}
                                          {% if option_key == cart_key %}
                                            selected
                                          {% endif %}
                                        >
                                          {{ option }}
                                        </option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                {% endif %}
                              </div>
                            </shoe-type-cart-updater>
                          </li>
                        {% endcomment %}

                        {%- comment -%}
                          SHOE TYPE SELECTOR - CONDITIONAL DISPLAY LOGIC

                          This snippet shows the logic for conditionally displaying the shoe type selector
                          based on excluded variant IDs.

                          LOGIC:
                          - Define excluded variant IDs (gift cards, accessories, etc.)
                          - Check if cart contains ONLY excluded variants
                          - If yes → HIDE selector
                          - If cart has excluded + orthotics → SHOW selector
                          - If cart has only orthotics → SHOW selector
                        {%- endcomment -%}

                        <li class="block break-inside-avoid pt-1">
                          {%- comment -%}
                            EXCLUDED VARIANT IDS CONFIGURATION
                            Add variant IDs that should NOT trigger the shoe type selector
                            Example: Gift cards, accessories, non-orthotic products
                          {%- endcomment -%}
                          {%- assign excluded_variant_ids = '40848945414208' | split: ',' -%}

                          {%- comment -%} Initialize tracking variables {%- endcomment -%}
                          {%- assign has_excluded_only = true -%}
                          {%- assign has_non_excluded = false -%}

                          {%- comment -%} Loop through all cart items to check variant IDs {%- endcomment -%}
                          {%- for item in cart.items -%}
                            {%- assign item_variant_id = item.variant.id | append: '' -%}
                            {%- assign is_excluded = false -%}

                            {%- comment -%} Check if current item's variant is in excluded list {%- endcomment -%}
                            {%- for excluded_id in excluded_variant_ids -%}
                              {%- assign excluded_id_trimmed = excluded_id | strip -%}
                              {%- if item_variant_id == excluded_id_trimmed -%}
                                {%- assign is_excluded = true -%}
                                {%- break -%}
                              {%- endif -%}
                            {%- endfor -%}

                            {%- comment -%} Track if we found any non-excluded items {%- endcomment -%}
                            {%- unless is_excluded -%}
                              {%- assign has_non_excluded = true -%}
                              {%- assign has_excluded_only = false -%}
                            {%- endunless -%}
                          {%- endfor -%}

                          {%- comment -%}
                            DISPLAY DECISION:
                            SHOW SELECTOR IF:
                            1. Cart is empty (default state)
                            2. Cart has ANY non-excluded items (orthotics present)

                            HIDE SELECTOR IF:
                            Cart has ONLY excluded items (gift cards only, no orthotics)
                          {%- endcomment -%}
                          {%- assign show_shoe_selector = false -%}
                          {%- if cart.items.size == 0 or has_non_excluded -%}
                            {%- assign show_shoe_selector = true -%}
                          {%- endif -%}

                          {%- comment -%} DEBUG: Output logic results (remove in production) {%- endcomment -%}
                          <script>
                            console.log('Shoe Selector Logic:', {
                              cartItemsCount: {{ cart.items.size }},
                              hasExcludedOnly: {{ has_excluded_only }},
                              hasNonExcluded: {{ has_non_excluded }},
                              showShoeSelector: {{ show_shoe_selector }},
                              excludedVariantIds: {{ excluded_variant_ids | json }},
                              cartVariantIds: [
                                {%- for item in cart.items -%}
                                  {{ item.variant.id }}{% unless forloop.last %},{% endunless %}
                                {%- endfor -%}
                              ]
                            });
                          </script>

                          {%- comment -%} Only render selector if conditions are met {%- endcomment -%}
                          {% if show_shoe_selector %}
                            <shoe-type-cart-updater>
                              {%- comment -%} Define shoe type options {%- endcomment -%}
                              {% assign shoe_options = "Sneakers (Also known as 'Tennis Shoes'),Running Shoes,Boots,Dress Shoes,Pickleball Shoes,Golf Shoes,Cycling Shoes,Basketball Shoes"
                                | split: ','
                              %}

                              {%- comment -%} Determine current pairs count from cart items {%- endcomment -%}
                              {% assign current_pairs = 1 %}
                              {% for item in cart.items %}
                                {% assign variant_title = item.variant.title %}
                                {% assign pairs_match = variant_title | split: ' ' | first %}
                                {% assign current_pairs = pairs_match | plus: 0 %}
                                {% break %}
                              {% endfor %}

                              <div class="space-y-1">
                                {%- comment -%} Pair 1 Selector - Always show when selector is visible {%- endcomment -%}
                                <div class="shoe-type-dropdown flex items-center gap-1">
                                  <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 1:</label>
                                  <select
                                    class="w-32 rounded border border-gray-300 bg-white px-2 text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                    data-pair="1"
                                    name="shoe_type_1"
                                  >
                                    <option value="" disabled>Select shoe type...</option>
                                    {% for option in shoe_options %}
                                      <option
                                        value="{{ option }}"
                                        {% assign option_key = option | split: ' ' | first | downcase %}
                                        {% assign cart_key = cart.attributes['Shoe Type']
                                          | split: ' '
                                          | first
                                          | downcase
                                        %}
                                        {% if option_key == cart_key %}
                                          selected
                                        {% endif %}
                                      >
                                        {{ option }}
                                      </option>
                                    {% endfor %}
                                  </select>
                                </div>

                                {%- comment -%} Pair 2 Selector - Show only if 2+ pairs {%- endcomment -%}
                                {% if current_pairs >= 2 %}
                                  <div class="shoe-type-dropdown flex items-center gap-1">
                                    <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 2:</label>
                                    <select
                                      class="w-32 rounded border border-gray-300 bg-white px-2  text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                      data-pair="2"
                                      name="shoe_type_2"
                                    >
                                      <option value="">Select shoe type...</option>
                                      {% for option in shoe_options %}
                                        <option
                                          value="{{ option }}"
                                          {% assign option_key = option | split: ' ' | first | downcase %}
                                          {% assign cart_key = cart.attributes['Shoe Type 2']
                                            | split: ' '
                                            | first
                                            | downcase
                                          %}
                                          {% if option_key == cart_key %}
                                            selected
                                          {% endif %}
                                        >
                                          {{ option }}
                                        </option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                {% endif %}

                                {%- comment -%} Pair 3 Selector - Show only if 3 pairs {%- endcomment -%}
                                {% if current_pairs >= 3 %}
                                  <div class="shoe-type-dropdown flex items-center gap-1">
                                    <label class="min-w-21 text-sm font-semibold text-gray-700">Shoe Type 3:</label>
                                    <select
                                      class="w-32 rounded border border-gray-300 bg-white px-2 text-[11px] focus:border-blue-500 focus:ring-1 focus:ring-blue-500"
                                      data-pair="3"
                                      name="shoe_type_3"
                                    >
                                      <option value="">Select shoe type...</option>
                                      {% for option in shoe_options %}
                                        <option
                                          value="{{ option }}"
                                          {% assign option_key = option | split: ' ' | first | downcase %}
                                          {% assign cart_key = cart.attributes['Shoe Type 3']
                                            | split: ' '
                                            | first
                                            | downcase
                                          %}
                                          {% if option_key == cart_key %}
                                            selected
                                          {% endif %}
                                        >
                                          {{ option }}
                                        </option>
                                      {% endfor %}
                                    </select>
                                  </div>
                                {% endif %}
                              </div>
                            </shoe-type-cart-updater>
                          {% else %}
                            {%- comment -%}
                              HIDDEN STATE: Cart has only excluded items
                              Optionally show a message or leave blank

                              <div class="text-sm text-gray-500 italic">
                                Shoe type selection not available for current cart items
                              </div>
                            {%- endcomment -%}
                          {% endif %}
                        </li>
                      </ul>
                    </div>

                    <button
                      type="button"
                      class="read-more-button mt-2 hidden text-sm font-bold text-blue-600 underline underline-offset-4 hover:text-blue-800 focus:underline focus:outline-none"
                      aria-expanded="false"
                    >
                      <span>View more +</span>
                    </button>
                  </div>
                </cart-item-customizations>
              </div>
            {% endif %}
          {% endif %}
        </cart-items>

        {%- comment -%} Only show premium add-ons if there are premium-add-on blocks {%- endcomment -%}
        {%- assign premium_blocks = section.blocks | where: 'type', 'premium-add-on' -%}
        {%- assign recommended_blocks = section.blocks | where: 'type', 'recommended-add-on' -%}

        {%- unless cart == empty -%}
          {%- if premium_blocks.size > 0 or recommended_blocks.size > 0 -%}
            <div class="flex flex-col gap-10">
              {%- if premium_blocks.size > 0 -%}
                <div class="cart__premium-add-ons flex flex-col gap-4">
                  <h3 class="text-eyebrow font-bold text-[#525A63] uppercase">Premium Add-Ons</h3>

                  <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
                    {%- for block in premium_blocks -%}
                      {% render 'product-quick-add-card',
                        layout: 'premium-add-ons',
                        product: block.settings.product,
                        subtitle: block.settings.subtitle
                      %}
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}

              {%- if recommended_blocks.size > 0 -%}
                <div class="cart__premium-add-ons flex flex-col gap-4">
                  <div class="flex items-center gap-4 whitespace-nowrap">
                    <hr class="border-blue-fitness/30 w-full">
                    <h3 class="text-eyebrow font-bold text-[#525A63] uppercase">We also recommend</h3>
                    <hr class="border-blue-fitness/30 w-full">
                  </div>

                  <div class="grid grid-cols-2 gap-4 md:grid-cols-1">
                    {%- for block in recommended_blocks -%}
                      {% render 'product-quick-add-card',
                        product: block.settings.product,
                        subtitle: block.settings.subtitle,
                        section_id: section.id
                      %}
                    {%- endfor -%}
                  </div>
                </div>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endunless -%}

        <style>
          .cart-variant-updating {
            opacity: 0.6;
            pointer-events: none;
            position: relative;
          }

          .cart-variant-updating::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
          }
          .variant-loading__spinner {
            background: rgba(255, 255, 255, 0);
            {% comment %} backdrop-filter: blur(2px); {% endcomment %}
          }
        </style>
      </section>

      {%- comment -%} Start cart summary{%- endcomment -%}

      {%- comment -%}
        Calculate variant savings ONLY for specific options
        Currently: "Pairs" - easily extensible for future options
      {%- endcomment -%}

      {%- comment -%} Define which options should have savings calculations {%- endcomment -%}
      {% comment %} {%- assign discount_eligible_options = 'Pairs,Size,Color' | split: ',' -%} {% endcomment %}
      {%- assign discount_eligible_options = 'Pairs' | split: ',' -%}

      {%- assign total_variant_savings = 0 -%}
      {%- assign total_before_variant_discounts = 0 -%}
      {%- assign has_variant_savings = false -%}

      {%- comment -%} Calculate variant savings for each cart item {%- endcomment -%}
      {%- for item in cart.items -%}
        {%- assign item_has_eligible_option = false -%}
        {%- assign eligible_option_name = '' -%}

        {%- comment -%} Check if this item has any discount-eligible options {%- endcomment -%}
        {%- for option in item.product.options_with_values -%}
          {%- if discount_eligible_options contains option.name -%}
            {%- assign item_has_eligible_option = true -%}
            {%- assign eligible_option_name = option.name -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}

        {%- comment -%} Only calculate savings if item has eligible option {%- endcomment -%}
        {%- if item_has_eligible_option -%}
          {%- assign single_unit_price = 0 -%}
          {%- assign lowest_price_per_unit = 999999 -%}
          {%- assign found_single_unit = false -%}

          {%- comment -%} Handle different option types {%- endcomment -%}
          {%- case eligible_option_name -%}
            {%- when 'Pairs' -%}
              {%- comment -%} Find the 1 Pair variant for reference price {%- endcomment -%}
              {%- for variant in item.product.variants -%}
                {%- assign variant_option1_clean = variant.option1 | strip | downcase -%}
                {%- if variant_option1_clean == '1 pair' -%}
                  {%- assign single_unit_price = variant.price -%}
                  {%- assign found_single_unit = true -%}
                  {%- break -%}
                {%- endif -%}
              {%- endfor -%}

              {%- comment -%} If no 1 Pair found, find lowest price per pair {%- endcomment -%}
              {%- unless found_single_unit -%}
                {%- for variant in item.product.variants -%}
                  {%- assign variant_pairs_text = variant.option1 | strip -%}
                  {%- assign variant_pairs = variant_pairs_text | split: ' ' | first | plus: 0 -%}

                  {%- if variant_pairs > 0 -%}
                    {%- assign price_per_unit = variant.price | divided_by: variant_pairs -%}
                    {%- if price_per_unit < lowest_price_per_unit -%}
                      {%- assign lowest_price_per_unit = price_per_unit -%}
                    {%- endif -%}
                  {%- endif -%}
                {%- endfor -%}

                {%- if lowest_price_per_unit < 999999 -%}
                  {%- assign single_unit_price = lowest_price_per_unit -%}
                {%- endif -%}
              {%- endunless -%}

              {%- comment -%} Get current item's pair count {%- endcomment -%}
              {%- assign current_units_text = item.variant.option1 | strip -%}
              {%- assign current_units_count = current_units_text | split: ' ' | first | plus: 0 -%}

            {%- when 'Size' -%}
              {%- comment -%} Future: Handle size-based discounts {%- endcomment -%}
              {%- comment -%} Example: Small = 1 unit, Large = 3 units with discount {%- endcomment -%}
              {%- assign current_units_count = 1 -%}
              {%- comment -%} Add your size-based logic here {%- endcomment -%}

            {%- when 'Color' -%}
              {%- comment -%} Future: Handle color-based discounts {%- endcomment -%}
              {%- comment -%} Example: Multi-color packs vs single colors {%- endcomment -%}
              {%- assign current_units_count = 1 -%}
              {%- comment -%} Add your color-based logic here {%- endcomment -%}

            {%- else -%}
              {%- comment -%} Default: treat as single unit {%- endcomment -%}
              {%- assign current_units_count = 1 -%}
          {%- endcase -%}

          {%- comment -%} Calculate savings only if we found a reference price and buying multiple units {%- endcomment -%}
          {%- if single_unit_price > 0 and current_units_count > 1 -%}
            {%- comment -%} Calculate what customer would pay if buying individually {%- endcomment -%}
            {%- assign individual_total = single_unit_price | times: current_units_count | times: item.quantity -%}

            {%- comment -%} Calculate actual total for this item {%- endcomment -%}
            {%- assign actual_total = item.final_price | times: item.quantity -%}

            {%- comment -%} Calculate savings for this item {%- endcomment -%}
            {%- assign item_savings = individual_total | minus: actual_total -%}

            {%- if item_savings > 0 -%}
              {%- assign total_variant_savings = total_variant_savings | plus: item_savings -%}
              {%- assign total_before_variant_discounts = total_before_variant_discounts | plus: individual_total -%}
              {%- assign has_variant_savings = true -%}
            {%- else -%}
              {%- assign total_before_variant_discounts = total_before_variant_discounts | plus: actual_total -%}
            {%- endif -%}
          {%- else -%}
            {%- comment -%} Single unit items or no reference price - no savings {%- endcomment -%}
            {%- assign actual_total = item.final_price | times: item.quantity -%}
            {%- assign total_before_variant_discounts = total_before_variant_discounts | plus: actual_total -%}
          {%- endif -%}
        {%- else -%}
          {%- comment -%} Item doesn't have eligible options - no variant savings {%- endcomment -%}
          {%- assign actual_total = item.final_price | times: item.quantity -%}
          {%- assign total_before_variant_discounts = total_before_variant_discounts | plus: actual_total -%}
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} Rest of your existing discount code calculations... {%- endcomment -%}
      {%- assign discount_code_savings = 0 -%}
      {%- assign has_discount_codes = false -%}
      {%- for discount in cart.cart_level_discount_applications -%}
        {%- assign discount_code_savings = discount_code_savings | plus: discount.total_allocated_amount -%}
        {%- assign has_discount_codes = true -%}
      {%- endfor -%}

      {%- assign line_item_discount_savings = 0 -%}
      {%- assign has_line_item_discounts = false -%}
      {%- for item in cart.items -%}
        {%- for discount in item.line_level_discount_allocations -%}
          {%- assign line_item_discount_savings = line_item_discount_savings | plus: discount.amount -%}
          {%- assign has_line_item_discounts = true -%}
        {%- endfor -%}
      {%- endfor -%}

      {%- assign subtotal_after_variant_discounts = cart.original_total_price -%}
      {%- assign final_total = cart.total_price -%}

      {%- comment -%} Calculate compare at price savings {%- endcomment -%}
      {%- assign total_compare_at_savings = 0 -%}
      {%- assign total_compare_at_price = 0 -%}
      {%- assign has_compare_at_savings = false -%}

      {%- comment -%} Calculate compare at savings for each cart item {%- endcomment -%}
      {%- for item in cart.items -%}
        {%- if item.variant.compare_at_price and item.variant.compare_at_price > item.variant.price -%}
          {%- comment -%} Calculate savings per unit {%- endcomment -%}
          {%- assign unit_savings = item.variant.compare_at_price | minus: item.variant.price -%}

          {%- comment -%} Calculate total savings for this item (savings per unit × quantity) {%- endcomment -%}
          {%- assign item_compare_at_savings = unit_savings | times: item.quantity -%}

          {%- comment -%} Calculate total compare at price for this item {%- endcomment -%}
          {%- assign item_compare_at_total = item.variant.compare_at_price | times: item.quantity -%}

          {%- comment -%} Add to running totals {%- endcomment -%}
          {%- assign total_compare_at_savings = total_compare_at_savings | plus: item_compare_at_savings -%}
          {%- assign total_compare_at_price = total_compare_at_price | plus: item_compare_at_total -%}
          {%- assign has_compare_at_savings = true -%}
        {%- else -%}
          {%- comment -%} No compare at price or no savings - add regular price to total {%- endcomment -%}
          {%- assign item_regular_total = item.variant.price | times: item.quantity -%}
          {%- assign total_compare_at_price = total_compare_at_price | plus: item_regular_total -%}
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} Calculate compare at savings percentage {%- endcomment -%}
      {%- assign compare_at_savings_percentage = 0 -%}
      {%- if total_compare_at_savings > 0 and total_compare_at_price > 0 -%}
        {%- assign compare_at_savings_percentage = total_compare_at_savings
          | times: 100.0
          | divided_by: total_compare_at_price
          | round
        -%}
      {%- endif -%}

      {%- comment -%} Calculate selling plan/subscription savings {%- endcomment -%}
      {%- assign total_selling_plan_savings = 0 -%}
      {%- assign has_selling_plan_savings = false -%}

      {%- comment -%} Calculate selling plan savings for each cart item {%- endcomment -%}
      {%- for item in cart.items -%}
        {%- if item.selling_plan_allocation -%}
          {%- comment -%} Item has a selling plan/subscription {%- endcomment -%}

          {%- comment -%} Get the compare-at price (price before subscription discount) {%- endcomment -%}
          {%- assign price_before_subscription = item.selling_plan_allocation.compare_at_price -%}

          {%- comment -%} Get the selling plan discounted price {%- endcomment -%}
          {%- assign selling_plan_price = item.selling_plan_allocation.price -%}

          {%- comment -%} Calculate savings per unit {%- endcomment -%}
          {%- assign unit_savings = price_before_subscription | minus: selling_plan_price -%}

          {%- comment -%} Calculate total savings for this item (savings per unit × quantity) {%- endcomment -%}
          {%- if unit_savings > 0 -%}
            {%- assign item_selling_plan_savings = unit_savings | times: item.quantity -%}
            {%- assign total_selling_plan_savings = total_selling_plan_savings | plus: item_selling_plan_savings -%}
            {%- assign has_selling_plan_savings = true -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} Calculate individual discount percentages {%- endcomment -%}
      {%- assign compare_at_percentage = 0 -%}
      {%- assign selling_plan_percentage = 0 -%}

      {%- if has_compare_at_savings and total_compare_at_price > 0 -%}
        {%- assign compare_at_percentage = total_compare_at_savings
          | times: 100.0
          | divided_by: total_compare_at_price
          | round
        -%}
      {%- endif -%}

      {%- if has_selling_plan_savings -%}
        {%- comment -%} Get the selling plan discount percentage from the first item {%- endcomment -%}
        {%- for item in cart.items -%}
          {%- if item.selling_plan_allocation -%}
            {%- for adjustment in item.selling_plan_allocation.selling_plan.price_adjustments -%}
              {%- if adjustment.value_type == 'percentage' -%}
                {%- assign selling_plan_percentage = adjustment.value -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      {%- comment -%} Calculate additive percentage (50% + 20% = 70%) {%- endcomment -%}
      {%- assign additive_savings_percentage = compare_at_percentage | plus: selling_plan_percentage -%}

      {%- comment -%} Now calculate total_all_savings including selling plan savings {%- endcomment -%}
      {%- assign total_all_savings = total_variant_savings
        | plus: total_compare_at_savings
        | plus: discount_code_savings
        | plus: line_item_discount_savings
        | plus: total_selling_plan_savings
      -%}

      {%- comment -%} Calculate subtotal savings WITHOUT selling plan savings (for subtotal display) {%- endcomment -%}
      {%- assign subtotal_all_savings = total_variant_savings
        | plus: total_compare_at_savings
        | plus: discount_code_savings
        | plus: line_item_discount_savings
      -%}

      {%- comment -%} Calculate actual percentage (additive % calcuation, not compound) {%- endcomment -%}
      {%- assign savings_percentage = 0 -%}

      {%- comment -%} Add up all individual discount percentages {%- endcomment -%}
      {%- if has_compare_at_savings
        or has_variant_savings
        or has_selling_plan_savings
        or has_discount_codes
        or has_line_item_discounts
      -%}
        {%- comment -%} Start with compare-at percentage {%- endcomment -%}
        {%- assign savings_percentage = compare_at_percentage -%}

        {%- comment -%} Add selling plan percentage {%- endcomment -%}
        {%- if has_selling_plan_savings -%}
          {%- assign savings_percentage = savings_percentage | plus: selling_plan_percentage -%}
        {%- endif -%}

        {%- comment -%} Add discount code percentage if any {%- endcomment -%}
        {%- if has_discount_codes and discount_code_savings > 0 -%}
          {%- assign total_before_discount_codes = cart.total_price | plus: discount_code_savings -%}
          {%- assign discount_code_percentage = discount_code_savings
            | times: 100.0
            | divided_by: total_before_discount_codes
            | round
          -%}
          {%- assign savings_percentage = savings_percentage | plus: discount_code_percentage -%}
        {%- endif -%}

        {%- comment -%} Add line item discount percentage if any {%- endcomment -%}
        {%- if has_line_item_discounts and line_item_discount_savings > 0 -%}
          {%- assign total_before_line_discounts = cart.total_price | plus: line_item_discount_savings -%}
          {%- assign line_item_percentage = line_item_discount_savings
            | times: 100.0
            | divided_by: total_before_line_discounts
            | round
          -%}
          {%- assign savings_percentage = savings_percentage | plus: line_item_percentage -%}
        {%- endif -%}
      {%- endif -%}

      {% comment %}
        {%- assign savings_percentage = 0 -%}
        {%- assign total_before_all_discounts = cart.total_price | plus: total_all_savings -%}
        {%- if total_all_savings > 0 and total_before_variant_discounts > 0 -%}
          {%- assign savings_percentage = total_all_savings
            | times: 100.0
            | divided_by: total_before_all_discounts
            | round
          -%}
        {%- endif -%}
      {% endcomment %}

      {%- comment -%} Debug: Complete savings summary {%- endcomment -%}
      <script>
        {%- for item in cart.items -%}
          {%- assign item_has_eligible_option = false -%}
          {%- assign eligible_option_name = '' -%}
          {%- for option in item.product.options_with_values -%}
            {%- if discount_eligible_options contains option.name -%}
              {%- assign item_has_eligible_option = true -%}
              {%- assign eligible_option_name = option.name -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if item_has_eligible_option -%}
            {%- assign current_units_text = item.variant.option1 | strip -%}
            {%- assign current_units_count = current_units_text | split: ' ' | first | plus: 0 -%}
            //console.log('    - {{ item.product.title | json }}: {{ eligible_option_name }} = "{{ item.variant.option1 }}" ({{ current_units_count }} units × {{ item.quantity }} qty)');
          {%- endif -%}
        {%- endfor -%}


        {%- for item in cart.items -%}
          {%- if item.variant.compare_at_price and item.variant.compare_at_price > item.variant.price -%}
            {%- assign unit_savings = item.variant.compare_at_price | minus: item.variant.price -%}
            {%- assign item_savings = unit_savings | times: item.quantity -%}
            console.log('    - {{ item.product.title | json }}: Compare {{ item.variant.compare_at_price | money | json }} → Sale {{ item.variant.price | money | json }} ({{ unit_savings | money | json }} per unit × {{ item.quantity }} qty = {{ item_savings | money | json }} total)');
          {%- endif -%}
        {%- endfor -%}


        {%- for discount in cart.cart_level_discount_applications -%}
          console.log('    - {{ discount.title | json }}: {{ discount.total_allocated_amount | money | json }}');
        {%- endfor -%}


        {%- for item in cart.items -%}
          {%- assign item_line_discounts = 0 -%}
          {%- for discount in item.line_level_discount_allocations -%}
            {%- assign item_line_discounts = item_line_discounts | plus: discount.amount -%}
          {%- endfor -%}
          {%- if item_line_discounts > 0 -%}
            console.log('    - {{ item.product.title | json }}: {{ item_line_discounts | money | json }}');
            {%- for discount in item.line_level_discount_allocations -%}
              console.log('      → {{ discount.discount_application.title | json }}: {{ discount.amount | money | json }}');
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}

        console.log('');
      </script>

      <section
        class="main-cart-summary z-100 lg:col-span-5 {% if cart == empty %} is-empty{% endif %}"
        id="main-cart-footer"
        data-id="{{ section.id }}"
      >
        <div class="sticky top-8 z-10 lg:px-0">
          <div class="cart__footer isolate section-{{ section.id }}-padding border-blue-fitness/20 flex max-w-full rounded-lg border bg-white p-4 shadow-xs">
            <div class="cart__blocks flex w-full flex-col gap-4">
              {% for block in section.blocks %}
                {%- case block.type -%}
                  {%- when 'customizations' -%}
                  {%- when 'title' -%}
                    <div class="cart-title-block pb-4 " {{ block.shopify_attributes }}>
                      <h3 class="text-2xl font-bold">{{ block.settings.title }}</h3>
                      {% if block.settings.subtitle != blank %}
                        <p class="mt-1 text-sm text-gray-600">{{ block.settings.subtitle }}</p>
                      {% endif %}
                    </div>

                  {%- when 'promo' -%}
                    {%- liquid
                      case block.settings.alignment
                        when 'left'
                          assign text_alignment = 'text-left'
                        when 'center'
                          assign text_alignment = 'text-center'
                        when 'right'
                          assign text_alignment = 'text-right'
                      endcase
                    -%}

                    <div
                      class="product__promo product__block-{{ block.id }} font-bold uppercase {{ text_alignment }} {% if block.settings.display == 'inline' %}space-x-2 inline{% else %}space-y-3 block{% endif %} rounded-lg p-2 leading-normal tracking-widest md:p-3"
                      style="background-color: {{ block.settings.bg_color }}; color: {{ block.settings.text_color }};"
                      {{ block.shopify_attributes }}
                    >
                      {%- if block.settings.icon != blank -%}
                        <style>
                          .line-item__promo-icon {
                            width: {{ block.settings.icon_size }}px;
                            height: {{ block.settings.icon_size }}px;
                          }
                        </style>
                        {{
                          block.settings.icon
                          | image_url: width: 48
                          | image_tag: class: 'line-item__promo-icon inline align-middle'
                        }}
                      {%- endif -%}
                      <span class="align-middle">
                        {{- block.settings.title -}}
                      </span>

                      {%- if block.settings.button_label != blank -%}
                        <a
                          href="{{ block.settings.button_url }}"
                          class="hover:bg-peach inline-block rounded-4xl bg-black px-6 py-2 align-middle text-xs text-white transition-colors duration-200 ease-in-out"
                        >
                          {{- block.settings.button_label -}}
                        </a>
                      {%- endif -%}
                    </div>
                  {%- when 'discount' -%}
                    <cart-discount class="space-y-3 border-b border-black/10">
                      <!-- Discount Input Form -->
                      <form class="discount-form flex gap-4 overflow-hidden ">
                        <input
                          type="text"
                          name="discount"
                          value=""
                          placeholder="Enter discount code"
                          class="discount-input focus:ring-blue-fitness border-blue-fitness/40 w-full rounded-sm border bg-white px-4 py-2 text-black focus:border focus:ring-0 focus:outline-none"
                          autocomplete="off"
                        >
                        <button
                          type="submit"
                          class="discount-submit w-fit cursor-pointer rounded-3xl bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800 disabled:cursor-not-allowed disabled:opacity-50"
                          aria-label="Apply"
                        >
                          <span class="submit-text">Apply</span>
                          <span class="loading-text hidden"> Applying... </span>
                        </button>
                      </form>

                      <!-- Error Message -->
                      <div class="discount-error hidden rounded-sm border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-800">
                        <span class="error-message"></span>
                      </div>

                      <!-- Applied Discounts Container -->
                      <div class="applied-discounts space-y-2">
                        {%- if cart.discount_applications.size > 0 -%}
                          {%- for discount_application in cart.discount_applications -%}
                            <div class="discount-pill flex items-center justify-between rounded-full border border-green-200 bg-green-50 px-3 py-1 text-sm">
                              <div class="flex items-center space-x-2">
                                <svg class="h-4 w-4 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-medium text-green-800">{{ discount_application.title }}</span>
                                <span class="text-green-600"
                                  >-{{ discount_application.total_allocated_amount | money -}}
                                </span>
                              </div>
                              <button
                                type="button"
                                class="remove-discount ml-2 text-green-600 hover:text-green-800 focus:outline-none"
                                data-discount-code="{{ discount_application.title }}"
                                aria-label="Remove discount {{ discount_application.title }}"
                              >
                                <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                                  <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                              </button>
                            </div>
                          {%- endfor -%}
                        {%- endif -%}
                      </div>

                      <!-- Success Message (Hidden by default, shown via JS) -->
                      <div class="discount-success hidden rounded-sm border border-green-200 bg-green-50 px-3 py-2 text-sm text-green-800">
                        <span class="success-message"></span>
                      </div>
                    </cart-discount>

                  {%- when 'order_summary' -%}
                    <div class="cart-order-summary" {{ block.shopify_attributes }}>
                      <ul class="flex flex-col gap-1">
                        <li class="totals flex items-center justify-between gap-2">
                          <h2 class="totals__total font-semibold">Subtotal:</h2>
                          <p class="totals__total-value">
                            {% comment %} {{ cart.total_price | plus: total_all_savings | money_with_currency }} {% endcomment %}

                            {{ cart.total_price | plus: subtotal_all_savings | money_with_currency }}
                          </p>
                        </li>
                        <li class="totals flex items-center justify-between gap-2">
                          <h2 class="totals__total font-semibold">Shipping:</h2>
                          <p class="totals__total-value text-[#00990F]">FREE</p>
                        </li>
                        {%- if total_all_savings > 0 -%}
                          <li class="totals flex items-center justify-between gap-2">
                            <h2 class="totals__total font-semibold">Discounts:</h2>
                            <p class="totals__total-value text-[#00990F]">
                              -{{ total_all_savings | money_with_currency }}
                              {%- if savings_percentage > 0 -%}
                                <span class="savings-percentage"> ({{ savings_percentage }}% OFF)</span>
                              {%- endif -%}
                              {% comment %}
                                {%- if has_selling_plan_savings
                                  and compare_at_percentage > 0
                                  and selling_plan_percentage > 0
                                -%}
                                  <span class="savings-percentage mt-0.5 block text-xs" style="text-align: right;">
                                    ({{ compare_at_percentage }}% + {{ selling_plan_percentage }}% subscription)
                                  </span>
                                {%- endif -%}
                              {% endcomment %}
                              {%- if has_selling_plan_savings
                                and compare_at_percentage > 0
                                and selling_plan_percentage > 0
                              -%}
                                <span class="savings-percentage mt-0.5 block text-xs" style="text-align: right;">
                                  ({{ compare_at_percentage }}%
                                  {%- if has_discount_codes and discount_code_percentage > 0 -%}
                                    + {{ discount_code_percentage }}% code
                                  {%- endif -%}
                                  {%- if has_line_item_discounts and line_item_percentage > 0 -%}
                                    + {{ line_item_percentage }}% discount
                                  {%- endif -%}
                                  + {{ selling_plan_percentage }}% subscription)
                                </span>
                              {%- elsif compare_at_percentage > 0 -%}
                                {%- if has_discount_codes or has_line_item_discounts -%}
                                  {%- comment -%} Show breakdown even without subscription if there are multiple discounts {%- endcomment -%}
                                  <span class="savings-percentage mt-0.5 block text-xs" style="text-align: right;">
                                    ({{ compare_at_percentage }}%
                                    {%- if has_discount_codes and discount_code_percentage > 0 -%}
                                      + {{ discount_code_percentage }}% code
                                    {%- endif -%}
                                    {%- if has_line_item_discounts and line_item_percentage > 0 -%}
                                      + {{ line_item_percentage }}% discount
                                    {%- endif -%}
                                    )
                                  </span>
                                {%- endif -%}
                              {%- endif -%}
                            </p>
                          </li>
                        {%- endif -%}
                      </ul>

                      <div class="cart__pricing-breakdown mt-2 border-black/10 text-sm">
                        {%- if has_compare_at_savings -%}
                          <div class="discount-line compare-at-discount pb-1 pl-2">
                            <span class="discount-label">
                              <svg
                                stroke="currentColor"
                                fill="currentColor"
                                stroke-width="0"
                                viewBox="0 0 24 24"
                                height="15"
                                width="15"
                                class="inline"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path fill="none" d="M0 0h24v24H0z"></path><path d="M12.79 21 3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path><path d="M11.38 17.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l6.21-6.21c.78-.78.78-2.05 0-2.83L12.62.58C12.25.21 11.74 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM5 2h6.21L19 9.79 12.79 16 5 8.21V2z"></path><circle cx="7.25" cy="4.25" r="1.25"></circle>
                              </svg>
                              {{ section.settings.compare_savings_label | default: 'Compare at savings' }}:
                            </span>
                            <span class="discount-amount">-{{ total_compare_at_savings | money }}</span>
                          </div>
                        {%- endif -%}

                        {%- if has_variant_savings -%}
                          <div class="discount-line variant-discount pb-1 pl-2">
                            <span class="discount-label">
                              <svg
                                stroke="currentColor"
                                fill="currentColor"
                                stroke-width="0"
                                viewBox="0 0 24 24"
                                height="15"
                                width="15"
                                class="inline"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path fill="none" d="M0 0h24v24H0z"></path><path d="M12.79 21 3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path><path d="M11.38 17.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l6.21-6.21c.78-.78.78-2.05 0-2.83L12.62.58C12.25.21 11.74 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM5 2h6.21L19 9.79 12.79 16 5 8.21V2z"></path><circle cx="7.25" cy="4.25" r="1.25"></circle>
                              </svg>
                              Bundle Savings:
                            </span>
                            <span class="discount-amount">-{{ total_variant_savings | money }}</span>
                          </div>
                        {%- endif -%}

                        {%- comment -%} NEW: Discount code savings {%- endcomment -%}
                        {%- if has_discount_codes and discount_code_savings > 0 -%}
                          <div class="discount-line discount-code-savings pb-1 pl-2">
                            <span class="discount-label">
                              <svg
                                stroke="currentColor"
                                fill="currentColor"
                                stroke-width="0"
                                viewBox="0 0 24 24"
                                height="15"
                                width="15"
                                class="inline"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path fill="none" d="M0 0h24v24H0z"></path><path d="M12.79 21 3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path><path d="M11.38 17.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l6.21-6.21c.78-.78.78-2.05 0-2.83L12.62.58C12.25.21 11.74 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM5 2h6.21L19 9.79 12.79 16 5 8.21V2z"></path><circle cx="7.25" cy="4.25" r="1.25"></circle>
                              </svg>
                              Discount Code:
                            </span>
                            <span class="discount-amount">-{{ discount_code_savings | money }}</span>
                          </div>
                        {%- endif -%}

                        {%- comment -%} NEW: Line item discount savings {%- endcomment -%}
                        {%- if has_line_item_discounts and line_item_discount_savings > 0 -%}
                          <div class="discount-line line-item-discount pb-1 pl-2">
                            <span class="discount-label">
                              <svg
                                stroke="currentColor"
                                fill="currentColor"
                                stroke-width="0"
                                viewBox="0 0 24 24"
                                height="15"
                                width="15"
                                class="inline"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path fill="none" d="M0 0h24v24H0z"></path><path d="M12.79 21 3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path><path d="M11.38 17.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l6.21-6.21c.78-.78.78-2.05 0-2.83L12.62.58C12.25.21 11.74 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM5 2h6.21L19 9.79 12.79 16 5 8.21V2z"></path><circle cx="7.25" cy="4.25" r="1.25"></circle>
                              </svg>
                              Line Item Discount:
                            </span>
                            <span class="discount-amount">-{{ line_item_discount_savings | money }}</span>
                          </div>
                        {%- endif -%}

                        {%- comment -%} NEW: Add selling plan savings line {%- endcomment -%}
                        {%- if has_selling_plan_savings -%}
                          <div class="discount-line selling-plan-discount pb-1 pl-2">
                            <span class="discount-label">
                              <svg
                                stroke="currentColor"
                                fill="currentColor"
                                stroke-width="0"
                                viewBox="0 0 24 24"
                                height="15"
                                width="15"
                                class="inline"
                                xmlns="http://www.w3.org/2000/svg"
                              >
                                <path fill="none" d="M0 0h24v24H0z"></path>
                                <path d="M12.79 21 3 11.21v2c0 .53.21 1.04.59 1.41l7.79 7.79c.78.78 2.05.78 2.83 0l6.21-6.21c.78-.78.78-2.05 0-2.83L12.79 21z"></path>
                                <path d="M11.38 17.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l6.21-6.21c.78-.78.78-2.05 0-2.83L12.62.58C12.25.21 11.74 0 11.21 0H5C3.9 0 3 .9 3 2v6.21c0 .53.21 1.04.59 1.41l7.79 7.79zM5 2h6.21L19 9.79 12.79 16 5 8.21V2z"></path>
                                <circle cx="7.25" cy="4.25" r="1.25"></circle>
                              </svg>
                              Subscription Savings:
                            </span>
                            <span class="discount-amount">-{{ total_selling_plan_savings | money }}</span>
                          </div>
                        {%- endif -%}
                      </div>
                    </div>

                    <div
                      class="mobile-only-subtotal right-0 bottom-0 left-0 z-100 flex w-full flex-col gap-4 border-t border-t-black/10 bg-white  p-0 pt-4 text-black lg:relative lg:mt-2 lg:hidden"
                      {{ block.shopify_attributes }}
                    >
                      <div class="totals flex items-center justify-between gap-2">
                        <h2 class="totals__total font-semibold">{{ 'sections.cart.estimated_total' | t }}:</h2>
                        <p class="totals__total-value text-2xl font-semibold">
                          {{ cart.total_price | money }}
                        </p>
                      </div>
                    </div>

                  {%- when 'subtotal_and_checkout' -%}
                    <div
                      class="fixed right-0 bottom-0 left-0 z-100 flex w-full flex-col gap-4 bg-[#292D31] p-5 text-white lg:relative lg:mt-2 lg:border-t lg:border-t-black/10 lg:bg-white lg:p-0 lg:pt-4 lg:text-black"
                      {{ block.shopify_attributes }}
                    >
                      <div class="totals estimated-total flex items-center justify-between gap-2">
                        <h2 class="totals__total font-semibold">{{ 'sections.cart.estimated_total' | t }}</h2>
                        <p class="totals__total-value text-2xl font-semibold">
                          {{ cart.total_price | money_with_currency }}
                        </p>
                      </div>

                      <div class="shop-pay-messaging text-sm">
                        {% form 'cart', cart %}
                          {{ form | payment_terms }}
                        {% endform %}
                      </div>

                      <div class="cart__ctas" {{ block.shopify_attributes }} style="">
                        <style>
                          .cart__ctas {
                            @media (max-width: 1023px) {
                              --color-foreground: 255, 255, 255;
                              --color-button: 234, 204, 164;
                              --color-button-text: 0, 0, 0;
                              --color-button-hover: 103, 113, 123;
                              --color-button-label-hover: 255, 255, 255;
                            }
                            --color-checkout-button: 74, 0, 224;
                            --color-button: 234, 203, 164;
                            --color-button-text: 0, 0, 0;
                            --color-button-hover: 103, 113, 123;
                            --color-button-label-hover: 255, 255, 255;
                          }
                          #checkout .btn-primary__inner {
                            background-color: rgb(var(--color-checkout-button));
                            color: white;
                          }
                        </style>
                        <button
                          type="submit"
                          id="checkout"
                          class="cart__checkout-button btn-primary w-full font-bold"
                          name="checkout"
                          {% if cart == empty %}
                            disabled
                          {% endif %}
                          form="cart"
                        >
                          <div class="btn-primary__inner">
                            <div class="btn-primary__text-wrapper">
                              <div class="btn-primary__text">{{ 'sections.cart.checkout' | t }}</div>
                              <div class="btn-primary__text">{{ 'sections.cart.checkout' | t }}</div>
                            </div>
                          </div>
                        </button>
                      </div>

                      <div class="footer__payment hidden lg:block">
                        <span class="sr-only">{{ 'sections.footer.payment' | t }}</span>
                        <ul class="list list-payment flex flex-wrap items-center justify-center gap-4" role="list">
                          {%- for type in shop.enabled_payment_types -%}
                            {%- unless type == 'diners_club'
                              or type == 'jcb'
                              or type == ' maestro'
                              or type == 'shopify_pay'
                              or type == 'unionpay'
                            -%}
                              <li class="list-payment__item">
                                {{ type | payment_type_svg_tag: class: 'icon icon--full-color' }}
                              </li>
                            {%- endunless -%}
                          {%- endfor -%}
                          <li class="list-payment__item">{{ 'payment_icon_fsa.svg' | inline_asset_content }}</li>
                          <li class="list-payment__item">{{ 'payment_icon_hsa.svg' | inline_asset_content }}</li>
                        </ul>
                      </div>
                    </div>
                {%- endcase -%}
              {% endfor %}

              <div id="cart-errors"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Get quiz data from localStorage
    const quizDataString = localStorage.getItem('quiz_data');
    let quizData = {};

    if (quizDataString) {
      try {
        quizData = JSON.parse(quizDataString);
        console.log('Quiz data loaded from localStorage:', quizData);
      } catch (error) {
        console.error('Error parsing quiz data from localStorage:', error);
        // Fallback to empty object if parsing fails
        quizData = {};
      }
    } else {
      console.log('No quiz data found in localStorage');
    }

    // Make variant ID configurable or pull from page data
    const variantId = '40612665458752'; // Consider making this dynamic

    const urlToChoiceMapping = {
      reason: {
        'Foot Pain': 'ff23474d-fb25-46ce-ab48-0f1c1a38574c',
        'Improving Posture': '1b80cbc8-2768-408e-90c3-7372745200ee',
        'General Wellness': 'd636e42c-1181-4465-a72d-78e5a6f88920',
        'Foot Fatigue': '146a1e16-c213-4242-a610-0e04f0072831',
        'Injury Prevention': '6d6283d1-8a93-409e-81ac-5d278dbf34f9',
        'Excelling in Sports': 'a28fd8eb-b61d-41f2-9b69-5895e9e8520f',
      },
      arch: {
        'Normal Arch': '11cba6a3-e443-4beb-b615-a15fd0d89153',
        'Flat Foot': '7e90cd34-ae54-45ac-bbef-b30db2e2b8df',
        'High Arches': 'c4854615-fbf9-4dfa-8c86-062004a54fa7',
        'Not Sure': '68cb05dc-f2e3-449d-8218-d7601fef5c85',
      },
      pain_freq: {
        'All the time': '2cdf112c-2854-4885-975c-e98f0745b14f',
        'After a long day': 'a4e32c51-71ee-4543-bedb-e8b6cf4f1a63',
        'Once in a while': '89ebadb9-41a1-429a-a825-303ca6bf3ab4',
        'Almost never': 'cec7f907-ca90-4c47-a033-2466572355c6',
      },
      condition: {
        None: 'f5a443b4-3e51-414b-9bbc-df20feba17f0',
        'Flat Feet': 'f0c7fbe8-11a0-472a-b435-66fa8892a252',
        'Plantar Fasciitis': 'ad488555-9889-40d3-8cdd-5213306f99a2',
        Bunions: 'b7f3b7a4-8fbd-4b1f-8ab3-bd553e0308e4',
        'Hammer Toes': '6061bd1c-a6d6-48f3-9625-cc235d773af9',
        "Morton's Neuroma": 'd99e50de-90ac-455b-9697-ef4c9a2549ca',
        Arthritis: 'f2470ac7-bb12-4b4c-95dd-e3ff863f3762',
        'Heel Spurs': 'ac2b5a58-637f-40b4-9067-41173045144c',
        'Limb-Length Discrepancy': '3a356b27-aafc-4e0d-90f6-1cc1093e379d',
        Metatarsalgia: 'f16699fa-8acb-45a8-b475-373af7eb2cab',
        'Achilles Tendinitis': '1753ce11-3ae9-43a5-a055-0a16deef25a8',
        Sesamoiditis: 'f3360196-b220-4079-b774-3e109bf0df16',
      },
      gender: {
        Mens: 'c751b349-5804-47bc-ade3-dfa1717ad5b0',
        Womens: '05a4d255-92ec-45c5-9129-1053e30d9d19',
      },
      shoe: {
        "Sneakers (Also known as 'Tennis Shoes')": '971f8970-1f30-4052-8f96-72fcb5774bdf',
        'Running Shoes': 'ee4a9425-0c8c-4bc0-8471-c623cb827129',
        Boots: '5933e9a0-a91e-4337-9c2d-722a4c612054',
        'Dress Shoes': 'c1a63c62-c287-440f-93c5-fbf8c7cf22e8',
        'Pickleball Shoes': 'c34b386d-1a56-4faf-8854-da9e31491cbe',
        'Golf Shoes': '9cf9342c-5819-4ab3-8e03-f4f03bcdf0d6',
        'Cycling Shoes': '2a6c5117-fc61-4183-a53b-65481a934f66',
        'Basketball Shoes': 'b913b084-6f6e-4088-9ace-07fb2ab829f4',
      },
    };

    // Helper function to safely get UUID from mapping
    function getUuidFromMapping(category, value) {
      if (!value || !urlToChoiceMapping[category] || !urlToChoiceMapping[category][value]) {
        console.warn(`No UUID mapping found for ${category}: "${value}"`);
        return null;
      }
      return urlToChoiceMapping[category][value];
    }

    // Only proceed if we have quiz data
    if (Object.keys(quizData).length > 0) {
      // Extract gender from size field (with safety check)
      const gender = quizData['Size'] && quizData['Size'].toLowerCase().startsWith('mens') ? 'Mens' : 'Womens';

      // Build query parameters using the exact labels as keys
      const queryParams = new URLSearchParams();

      // Add parameters with better error handling
      // do not code a preselect for the first question
      // const reasonUuid = getUuidFromMapping('reason', quizData["Reason"]);
      // if (reasonUuid) queryParams.append('reason', reasonUuid);

      const archUuid = getUuidFromMapping('arch', quizData['Arch']);
      if (archUuid) queryParams.append('arch', archUuid);

      const painFreqUuid = getUuidFromMapping('pain_freq', quizData['Pain Frequency']);
      if (painFreqUuid) queryParams.append('pain_freq', painFreqUuid);

      const conditionUuid = getUuidFromMapping('condition', quizData['Condition']);
      if (conditionUuid) queryParams.append('condition', conditionUuid);

      const genderUuid = getUuidFromMapping('gender', gender);
      if (genderUuid) queryParams.append('gender', genderUuid);

      const shoeUuid = getUuidFromMapping('shoe', quizData['Shoe Type']);
      if (shoeUuid) queryParams.append('shoe', shoeUuid);

      // Always add variant and pairs
      queryParams.append('variant', variantId);
      queryParams.append('pairs', '1');

      const finalUrl = `https://www.stridesoles.com/pages/quiz?${queryParams.toString()}`;
      const bodyElement = document.querySelector('body');
      console.log('Final URL:', finalUrl);

      bodyElement.setAttribute('data-retake-quiz-url', finalUrl);

      // Function to inject quiz links
      function injectQuizLinks() {
        const cartCustomizations = document.querySelectorAll('.cart-item__customization');

        if (cartCustomizations.length > 0) {
          cartCustomizations.forEach((element, index) => {
            // Check if there's already a retake-quiz-link to avoid duplicates
            const existingLink = element.querySelector('.retake-quiz-link');

            if (existingLink) {
              // Update existing link with the new URL and click handler
              existingLink.href = '#'; // Change this line

              // Remove old event listeners and add new one
              existingLink.replaceWith(existingLink.cloneNode(true));
              const newExistingLink = element.querySelector('.retake-quiz-link');

              newExistingLink.addEventListener('click', function (e) {
                e.preventDefault();

                fetch('/cart/clear.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                })
                  .then((response) => response.json())
                  .then((data) => {
                    console.log('Cart cleared successfully');
                    window.location.href = finalUrl;
                  })
                  .catch((error) => {
                    console.error('Error clearing cart:', error);
                    window.location.href = finalUrl;
                  });
              });

              console.log(`Updated existing quiz link ${index + 1} with cart clear functionality`);
            } else {
              // Ensure parent element has relative positioning
              if (getComputedStyle(element).position === 'static') {
                element.style.position = 'relative';
              }

              // Create new link element
              const quizLink = document.createElement('a');
              quizLink.className = 'retake-quiz-link';
              quizLink.href = '#'; // Change from finalUrl to #
              quizLink.textContent = 'Edit';

              // Add click handler to clear cart first
              quizLink.addEventListener('click', function (e) {
                e.preventDefault(); // Prevent default link behavior

                // Clear the cart first
                fetch('/cart/clear.js', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                })
                  .then((response) => response.json())
                  .then((data) => {
                    console.log('Cart cleared successfully');
                    // Now redirect to the quiz
                    window.location.href = finalUrl;
                  })
                  .catch((error) => {
                    console.error('Error clearing cart:', error);
                    // Still redirect even if cart clear fails
                    window.location.href = finalUrl;
                  });
              });

              // Insert the link into the customization element
              element.appendChild(quizLink);
              console.log(`Injected quiz link ${index + 1} into cart customization. updated.`);
            }
          });

          console.log(`Processed ${cartCustomizations.length} cart customization sections`);
        } else {
          console.log('No cart customization elements found on this page');
        }
      }

      // Try to inject links immediately, and also set up a fallback
      injectQuizLinks();

      // Fallback: try again after a short delay in case elements load asynchronously
      setTimeout(injectQuizLinks, 500);

      // Debug output to see each mapping
      console.log('Mappings:');
      //console.log("Reason:", quizData["Reason"], "->", reasonUuid);
      console.log('Arch:', quizData['Arch'], '->', archUuid);
      console.log('Pain Frequency:', quizData['Pain Frequency'], '->', painFreqUuid);
      console.log('Condition:', quizData['Condition'], '->', conditionUuid);
      console.log('Gender:', gender, '->', genderUuid);
      console.log('Shoe Type:', quizData['Shoe Type'], '->', shoeUuid);
    } else {
      console.log('No valid quiz data available to generate URL');
    }
  });
</script>

{% schema %}
{
  "name": "Cart",
  "class": "section-main-cart",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.all.padding.section_padding_heading"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "t:sections.all.padding.padding_bottom",
      "default": 36
    },
    {
      "type": "checkbox",
      "id": "hide_cart_header",
      "label": "Hide cart header",
      "default": false
    },
    {
      "type": "text",
      "id": "compare_savings_label",
      "label": "Compare Savings Label",
      "info": "(without a colon)",
      "default": "Compare at savings"
    },
    {
      "type": "header",
      "content": "Subscription Benefits"
    }
  ],
  "blocks": [
    {
      "type": "title",
      "name": "Title",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Order Summary"
        },
        {
          "type": "text",
          "id": "subtitle",
          "label": "Subtitle (optional)",
          "info": "Optional subtitle text below the title"
        }
      ]
    },
    {
      "type": "customizations",
      "name": "Customizations",
      "settings": []
    },
    {
      "type": "order_summary",
      "name": "Order summary",
      "limit": 1
    },
    {
      "type": "subtotal_and_checkout",
      "name": "Subtotal and checkout",
      "limit": 1
    },
    {
      "type": "promo",
      "name": "Promo",
      "settings": [
        {
          "type": "image_picker",
          "id": "icon",
          "label": "Icon",
          "info": "SVG preferred"
        },
        {
          "type": "range",
          "id": "icon_size",
          "label": "Icon size",
          "min": 8,
          "max": 200,
          "step": 4,
          "unit": "px",
          "default": 16
        },
        {
          "type": "inline_richtext",
          "id": "title",
          "label": "Title",
          "default": "180 Day Money-Back Guarantee"
        },
        {
          "type": "color",
          "id": "bg_color",
          "label": "Background color",
          "default": "#F4E5D1"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Text color",
          "default": "#000000"
        },
        {
          "type": "header",
          "content": "Display settings"
        },
        {
          "type": "select",
          "id": "display",
          "label": "Display",
          "options": [
            {
              "value": "column",
              "label": "Column"
            },
            {
              "value": "inline",
              "label": "Inline"
            }
          ],
          "default": "inline"
        },
        {
          "type": "text_alignment",
          "id": "alignment",
          "label": "Text alignment",
          "default": "center"
        }
      ]
    },
    {
      "type": "discount",
      "name": "Discount",
      "settings": [
        {
          "type": "inline_richtext",
          "id": "title",
          "label": "Title",
          "default": "75% OFF SUMMER SALE"
        },
        {
          "type": "inline_richtext",
          "id": "subtitle",
          "label": "Subtitle",
          "default": "Discount Auto-applied"
        },
        {
          "type": "inline_richtext",
          "id": "savings",
          "label": "Savings",
          "default": "Savings $451 (75% OFF)"
        }
      ]
    },
    {
      "type": "premium-add-on",
      "name": "premium-add-on",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "inline_richtext",
          "id": "subtitle",
          "label": "Subtitle"
        }
      ]
    },
    {
      "type": "recommended-add-on",
      "name": "recommended-add-on",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "inline_richtext",
          "id": "subtitle",
          "label": "Subtitle"
        }
      ]
    }
  ]
}
{% endschema %}
