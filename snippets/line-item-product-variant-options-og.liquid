{% comment %}
  Renders product variant options

  Accepts:
  - product: {Object} product object.
  - option: {Object} current product_option object.
  - block: {Object} block object.
  - picker_type: {String} type of picker to dispay


  Usage:
  {% render 'product-variant-options',
    product: product,
    option: option,
    block: block
    picker_type: picker_type
  %}
{% endcomment %}
{%- liquid
  assign product_form_id = 'product-form-' | append: section.id
-%}

{%- for value in option.values -%}
  {%- liquid
    assign option_name_handle = option.name | handleize

    assign option_disabled = true
    if value.available
      assign option_disabled = false
    endif

    # Find the variant ID for this option value
    assign variant_id = null
    for variant in product.variants
      if variant.option1 == value
        assign variant_id = variant.id
        break
      endif
    endfor

    # Check if this option value matches the current cart item's variant
    assign is_selected = false
    case option.position
      when 1
        if item.variant.option1 == value
          assign is_selected = true
        endif
      when 2
        if item.variant.option2 == value
          assign is_selected = true
        endif
      when 3
        if item.variant.option3 == value
          assign is_selected = true
        endif
    endcase

    # Check if this is the "most popular" option (2 pair)
    assign is_most_popular = false
    assign value_lowercase = value | downcase | strip
    if value_lowercase == '2 pair' or value_lowercase == '2 pairs'
      assign is_most_popular = true
    endif
  -%}

  {%- capture input_id -%}
    {{ item.key }}-{{ option.position }}-{{ forloop.index0 -}}
  {%- endcapture -%}

  {%- capture input_name -%}
    {{ option.name }}-{{ option.position }}-{{ item.key }}
  {%- endcapture -%}

  {%- capture input_dataset -%}
    data-product-url="{{ value.product_url }}"
    data-option-value-id="{{ value.id }}"
    data-variant-id="{{ variant_id }}"
  {%- endcapture -%}

  {%- capture label_unavailable -%}
    <span class="label-unavailable sr-only">
      {{- 'products.product.variant_sold_out_or_unavailable' | t -}}
    </span>
  {%- endcapture -%}

  {%- case picker_type -%}
    {%- when 'button' -%}
      <div class="relative flex-1">
        {%- if is_most_popular -%}
          <!-- Most Popular Badge -->
          <div class="absolute -top-5 left-1/2 z-10 -translate-x-1/2 transform lg:-top-4">
            <span class="inline-flex items-center rounded-full bg-[#3F16E2] px-2 py-1 text-[10px] font-medium whitespace-nowrap text-white shadow-sm">
              MOST POPULAR
            </span>
          </div>
        {%- endif -%}

        <input
          type="radio"
          id="{{ input_id }}"
          name="{{ input_name | escape }}"
          value="{{ value | escape }}"
          form="{{ product_form_id }}"
          {% if is_selected %}
            checked
          {% endif %}
          class="peer sr-only {% if option_disabled %}disabled{% endif %}"
          {{ input_dataset }}
        >
        <label
          for="{{ input_id }}"
          class="peer-checked:bg-human/10 peer-checked:border-human group inline-flex h-full w-full cursor-pointer flex-col items-center justify-start gap-1 rounded-md border border-[#E6E7E8] bg-transparent p-2 text-center text-black transition-colors duration-200 peer-checked:text-[#9C876D] md:py-3 lg:p-2"
        >
          <span class="md:text-body-l text-sm font-bold">{{- value -}}</span>

          {%- if option_name_handle == 'pairs' -%}
            {%- liquid
              # Find the variant price for this option
              assign variant_price = null
              for variant in product.variants
                # Check if this variant matches the current option value
                # NOTE: "Pairs" must be option1

                if variant.option1 == value
                  assign variant_price = variant.price
                  break
                endif
              endfor

              # Extract the number of pairs from the value string
              assign pairs_text = value | strip
              assign pairs_count = pairs_text | split: ' ' | first | plus: 0

              # More precise calculation for unit price
              assign price_in_cents = variant_price | times: 100
              assign unit_price_in_cents = price_in_cents | divided_by: pairs_count
              assign unit_price = unit_price_in_cents | times: 0.01 | round: 2

              # Calculate savings compared to 1 pair option
              assign single_pair_price = null
              for variant in product.variants
                if variant.option1 == '1 Pair'
                  assign single_pair_price = variant.price
                  break
                endif
              endfor

              assign savings = 0
              if single_pair_price and pairs_count > 1
                assign total_if_bought_separately = single_pair_price | times: pairs_count
                assign savings = total_if_bought_separately | minus: variant_price
              endif
            -%}
            {% if variant_price != null and pairs_count > 1 %}
              <span class="text-xs opacity-50 group-peer-checked:text-[#000000] group-peer-checked:opacity-100 xl:text-sm">
                {{- unit_price | money }} / ea
              </span>

              {% if savings > 0 %}
                <span class="text-green group-peer-checked:text-green mt-2 text-xs font-medium">
                  Save {{ savings | money }}
                </span>
              {% endif %}
            {%- else -%}
              <span class="text-xs opacity-50 group-peer-checked:text-[#000000] group-peer-checked:opacity-100 xl:text-sm">
                {{- variant_price | money -}}
              </span>
            {% endif %}
          {%- endif -%}
          {{ label_unavailable }}
        </label>
      </div>
    {%- else -%}
  {%- endcase -%}
{%- endfor -%}
